<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/constant.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
</head>
<body>
    <script type="text/javascript">
        var LocalID = $.cookie("LocalID");
        var dd;
        var datagrid2;
        var jsondata2 = { "total": 0, "rows": [] };
        $(function () {
            Ajax(true, global.xf["GetXFMngWindowGrpList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#belong_group').combobox({
                    data: data.Data,
                    valueField: 'id',
                    textField: 'group_name'
                });
            });
            var editRow = undefined;
            datagrid2 = $("#dg2").datagrid({
                idField: "id",
                fitColumns: true,
                striped: true,
                title: "",
                collapsible: true,
                remotesort: false,
                rownumbers: true,
                columns: [[{
                    field: 'window_num',
                    title: '机器号',
                    width: '16%'
                }, {
                    field: 'belong_group',
                    title: '班组',
                    width: '16%'
                }, {
                    field: 'ip',
                    title: 'IP',
                    width: '16%'
                }, {
                    field: 'mach_type',
                    title: '类型',
                    width: '16%'
                }, {
                    field: 'only_money',
                    title: '单次最大消费',
                    width: '16%'
                }, {
                    field: 'day_money',
                    title: '日最大消费',
                    width: '16%'
                }]]
            });
            loaddata2();
            $('#win2').window('close');
            $("#close2").click(function () {
                $('#win2').window('close');
            });
            $("#add2").click(function () {
                $('#win2').window('open');
                $("#window_num").val("");
                $("#belong_group").combobox("setValue", "");
                $("#ip").val("");
                $("#mach_type").combobox("setValue", "");
                $("#mach_type").combobox({
                    onSelect: function (n, o) {
                        var mach_type = $("#mach_type").combobox("getValue");
                        if (mach_type == 01 || mach_type == 02) {
                            $("#unnet_flag").combobox({ "disabled": true });
                            $("#win_name").attr("disabled", true);
                            $("#format1").attr("disabled", true);
                            $("#format2").attr("disabled", true);
                            $("#format3").attr("disabled", true);
                            $("#format4").attr("disabled", true);
                            $("#only_money").attr("disabled", false);
                            $("#day_money").attr("disabled", false);
                            $("#only_money").val("");
                            $("#day_money").val("");
                            dd = 1;
                        }
                        else {
                            $("#unnet_flag").combobox({ "disabled": false });
                            $("#win_name").attr("disabled", false);
                            $("#format1").attr("disabled", false);
                            $("#format2").attr("disabled", false);
                            $("#format3").attr("disabled", false);
                            $("#format4").attr("disabled", false);
                            $("#only_money").attr("disabled", true);
                            $("#day_money").attr("disabled", true);
                            $("#unnet_flag").combobox("setValue", "");
                            $("#win_name").val("");
                            $("#format1").val("");
                            $("#format2").val("");
                            $("#format3").val("");
                            $("#format4").val("");
                            dd = 2;
                        }
                    }
                });
            });
            $("#update2").click(function () {

                var rows = datagrid2.datagrid('getSelected');
                if (rows == null) {
                    $.messager.alert("提示", "未选择项", "error");
                    return;
                }
                $('#win2').window('open');
                $("#window_num").val(rows.window_num);
                $("#belong_group").combobox(rows.belong_group);
                $("#ip").val(rows.ip);
                $("#mach_type").combobox(rows.mach_type);
                $("#mach_type").combobox({
                    onChange: function (n, o) {
                        var mach_type = $("#mach_type").combobox("getValue");
                        if (mach_type == 01 || mach_type == 02) {
                            $("#unnet_flag").combobox({ "disabled": true });
                            $("#win_name").attr("disabled", true);
                            $("#format1").attr("disabled", true);
                            $("#format2").attr("disabled", true);
                            $("#format3").attr("disabled", true);
                            $("#format4").attr("disabled", true);
                            $("#only_money").attr("disabled", false);
                            $("#day_money").attr("disabled", false);
                            $("#only_money").val(rows.only_money);
                            $("#day_money").val(rows.day_money);
                            dd = 3;
                        }
                        else {
                            $("#unnet_flag").combobox({ "disabled": false });
                            $("#win_name").attr("disabled", false);
                            $("#format1").attr("disabled", false);
                            $("#format2").attr("disabled", false);
                            $("#format3").attr("disabled", false);
                            $("#format4").attr("disabled", false);
                            $("#only_money").attr("disabled", true);
                            $("#day_money").attr("disabled", true);
                            $("#unnet_flag").combobox(rows.unnet_flag);
                            $("#win_name").val(rows.win_name);
                            $("#format1").val(rows.format1);
                            $("#format2").val(rows.format2);
                            $("#format3").val(rows.format3);
                            $("#format4").val(rows.format4);
                            dd = 4;
                        }
                    }
                });
            });
            $("#save2").click(function () {
                if (dd == 1) {
                    var window_num = $("#window_num").val();
                    var belong_group = $('#belong_group').combobox("getValue");
                    var ip = $("#ip").val();
                    var mach_type = $('#mach_type').combobox("getValue");
                    var only_money = $("#only_money").val();
                    var day_money = $("#day_money").val();
                    if (window_num == "") {
                        alert("机器号不能为空！");
                        return;
                    }
                    if (ip == "") {
                        alert("IP不能为空！");
                        return;
                    }
                    var re = /^(\d+)\.(\d+)\.(\d+)\.(\d+)$/; //正则表达式
                    if (re.test(ip)) {
                        if (RegExp.$1 < 256 && RegExp.$2 < 256 && RegExp.$3 < 256 && RegExp.$4 < 256)
                            return;
                    }
                    else {
                        alert("IP有误！");
                        return;
                    }

                    if (only_money == "") {
                        alert("单次最大消费不能为空！");
                        return;
                    }
                    if (day_money == "") {
                        alert("日最大消费不能为空！");
                        return;
                    }
                    Ajax(true, global.xf["NewXFMngWindow"], { LoginID: LocalID, window_num: window_num, belong_group: belong_group, ip: ip, mach_type: mach_type, only_money: only_money, day_money: day_money }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        $.messager.alert("提示", "添加成功", "info");
                        $('#win2').window('close');
                        loaddata2();
                    });
                }
                if (dd == 2) {
                    var window_num = $("#window_num").val();
                    var belong_group = $('#belong_group').combobox("getValue");
                    var ip = $("#ip").val();
                    var mach_type = $('#mach_type').combobox("getValue");
                    if (window_num == "") {
                        alert("机器号不能为空！");
                        return;
                    }
                    if (ip == "") {
                        alert("IP不能为空！");
                        return;
                    }
                    var re = /^(\d+)\.(\d+)\.(\d+)\.(\d+)$/; //正则表达式
                    if (re.test(ip)) {
                        if (RegExp.$1 < 256 && RegExp.$2 < 256 && RegExp.$3 < 256 && RegExp.$4 < 256) {
                            var unnet_flag = $("#unnet_flag").combobox("getValue");
                            var win_name = $("#win_name").val();
                            var format1 = $("#format1").val();
                            var format2 = $("#format2").val();
                            var format3 = $("#format3").val();
                            var format4 = $("#format4").val();
                            if (win_name == "") {
                                alert("商户名不能为空！");
                                return;
                            }
                            if (format1 == "") {
                                alert("打印抬头不能为空！");
                                return;
                            }
                            if (format2 == "") {
                                alert("打印脚尾1不能为空！");
                                return;
                            }
                            if (format3 == "") {
                                alert("打印脚尾2不能为空！");
                                return;
                            }
                            if (format4 == "") {
                                alert("打印脚尾3不能为空！");
                                return;
                            }
                            Ajax(true, global.xf["NewXFMngWindow"], { LoginID: LocalID, window_num: window_num, belong_group: belong_group, ip: ip, mach_type: mach_type, win_name: win_name, format1: format1, format2: format2, format3: format3, format4: format4, unnet_flag: unnet_flag }, function (data) {
                                if (!data.Success) {
                                    alert(data.Message);
                                    return;
                                }
                                $.messager.alert("提示", "添加成功", "info");
                                $('#win2').window('close');
                                loaddata2();
                            });

                        }
                        if (dd == 3) {
                            var rows = datagrid2.datagrid('getSelected');
                            var id = rows.id;
                            var window_num = $("#window_num").val(rows.window_num);
                            var belong_group = $("#belong_group").combobox(rows.belong_group);
                            var ip = $("#ip").val(rows.ip);
                            var mach_type = $("#mach_type").combobox(rows.mach_type);
                            if (window_num == "") {
                                alert("机器号不能为空！");
                                return;
                            }
                            if (ip == "") {
                                alert("IP不能为空！");
                                return;
                            }
                            var re = /^(\d+)\.(\d+)\.(\d+)\.(\d+)$/; //正则表达式
                            if (re.test(ip)) {
                                if (RegExp.$1 < 256 && RegExp.$2 < 256 && RegExp.$3 < 256 && RegExp.$4 < 256)
                                    return;
                            }
                            else {
                                alert("IP有误！");
                                return;
                            }
                            var only_money = $("#only_money").val(rows.only_money);
                            var day_money = $("#day_money").val(rows.day_money);
                            if (only_money == "") {
                                alert("单次最大消费不能为空！");
                                return;
                            }
                            if (day_money == "") {
                                alert("日最大消费不能为空！");
                                return;
                            }
                            Ajax(true, global.xf["UpdateXFMngWindow"], { LoginID: LocalID, window_num: window_num, belong_group: belong_group, ip: ip, mach_type: mach_type, only_money: only_money, day_money: day_money, id: id }, function (data) {
                                if (!data.Success) {
                                    alert(data.Message);
                                    return;
                                }
                                $.messager.alert("提示", "添加成功", "info");
                                $('#win2').window('close');
                                loaddata2();
                            });
                        }
                        if (dd == 4) {
                            var rows = datagrid2.datagrid('getSelected');
                            var id = rows.id;
                            var unnet_flag = $('#unnet_flag').combobox("getValue");
                            var win_name = $("#win_name").val();
                            var format1 = $("#format1").val();
                            var format2 = $("#format2").val();
                            var format3 = $("#format3").val();
                            var format4 = $("#format4").val();
                            var mach_type = $("#mach_type").combobox(rows.mach_type);
                            if (window_num == "") {
                                alert("机器号不能为空！");
                                return;
                            }
                            if (ip == "") {
                                alert("IP不能为空！");
                                return;
                            }
                            if (win_name == "") {
                                alert("商户名不能为空！");
                                return;
                            }
                            if (format1 == "") {
                                alert("打印抬头不能为空！");
                                return;
                            }
                            if (format2 == "") {
                                alert("打印脚尾1不能为空！");
                                return;
                            }
                            if (format3 == "") {
                                alert("打印脚尾2不能为空！");
                                return;
                            }
                            if (format4 == "") {
                                alert("打印脚尾3不能为空！");
                                return;
                            }
                            Ajax(true, global.xf["UpdateXFMngWindow"], { LoginID: LocalID, window_num: window_num, belong_group: belong_group, ip: ip, mach_type: mach_type, win_name: win_name, format1: format1, unnet_flag: unnet_flag, format2: format2, format3: format3, format4: format4, id: id }, function (data) {
                                if (!data.Success) {
                                    alert(data.Message);
                                    return;
                                }
                                $.messager.alert("提示", "添加成功", "info");
                                $('#win2').window('close');
                                loaddata2();
                            });
                        }
                    }
                    else {
                        alert("IP有误！");
                        return;
                    }
                    
                }
            });

            $("#remove2").click(function () {
                var rowData = datagrid2.datagrid('getSelections');
                var ids;
                if (rowData == null || rowData.length == 0) {
                    $.messager.alert("提示", "未选择项", "error");
                    return;
                }
                $.messager.confirm("提示", "确定要删除所选项？", function (data) {
                    if (data) {
                        for (var i = 0; i < rowData.length; i++) {
                            ids = rowData[i].id;
                            Ajax(true, global.xf["RemoveXFMngWindow"], { LoginID: LocalID, id: ids }, function (data) {
                                if (!data.Success) {
                                    alert(data.Message);
                                    return;
                                }
                                loaddata2();
                            });
                        }
                        $.messager.alert("提示", "删除成功", "info");
                    }
                });
            });
        });

        function loaddata2() {
            datagrid2.datagrid('unselectAll');
            Ajax(true, global.xf["GetXFMngWindowList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jsondata2.rows = data.Data;
                datagrid2.datagrid('loadData', jsondata2);

            });
        }


    </script>
    <div class="easyui-layout">
        <a class="easyui-linkbutton" data-options="iconCls:'icon-add'" href="javascript:void(0)"
            id="add2" style="width: 80px">添加</a> <a class="easyui-linkbutton" data-options="iconCls:'icon-edit'"
                href="javascript:void(0)" id="update2" style="width: 80px">修改</a> <a class="easyui-linkbutton"
                    data-options="iconCls:'icon-remove'" href="javascript:void(0)" id="remove2" style="width: 80px">
                    删除</a>
        <div data-options="region:'left',split:true,collapsible:false" style="width: 100%;">
            <table id="dg2">
            </table>
        </div>
    </div>
</body>
</html>
