<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/constant.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
</head>
<body>
    <script type="text/javascript">
        var LocalID = $.cookie("LocalID");
        var dd;
        var datagrid2;
        var jsondata2 = { "total": 0, "rows": [] };
        $(function () {
            Ajax(true, global.sys["GetDepartList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#department').combobox({
                    data: data.Data,
                    valueField: 'id',
                    textField: 'department',
                    onSelect: function () {
                        var id = $('#department').combobox("getValue");
                        hqyff(id);
                        hqgj(id);
                        loaddata();
                    }
                });
            });
            Ajax(true, global.xf["GetXFMngBtmonthList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#btmonth').combobox({
                    data: data.Data,
                    valueField: 'id',
                    textField: 'id'
                });
            });


            datagrid2 = $("#dg").datagrid({
                idField: "id",
                fitColumns: true,
                striped: true,
                title: "",
                collapsible: true,
                remotesort: false,
                rownumbers: true,
                columns: [[{
                    field: 'user_file_id',
                    title: '姓名',
                    width: '10%'
                }, {
                    field: 'card_kind',
                    title: '工号',
                    width: '10%'
                }, {
                    field: 'granted_type',
                    title: '用户类型',
                    width: '10%'
                }, {
                    field: 'subsidy_money',
                    title: '补贴金额',
                    width: '10%'
                }, {
                    field: 'granted_operator',
                    title: '操作员',
                    width: '10%'
                }, {
                    field: 'granted_date',
                    title: '发放日期',
                    width: '10%'
                }, {
                    field: 'subsidy_granted',
                    title: '提取否',
                    width: '10%'
                }]]
            });
            loaddata();
            $('#save').hide();

            $("#ff").click(function () {
                $.messager.alert("提示", "是否发放补贴？", "info");
                $('#save').show();
            });
            $("#save").click(function () {
                var depart_id = $('#department').combobox("getValue");
                var btmonth_id = $('#btmonth').combobox("getValue");
                var subsidy_money = $('#subsidy_money').val();
                var subsidy_granted = 2;
                Ajax(true, global.xf["NewXFSubsidyGrant"], { LoginID: LocalID, depart_id: depart_id, btmonth_id: btmonth_id, subsidy_money: subsidy_money, subsidy_granted: subsidy_granted }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    loaddata();
                });
                $.messager.alert("提示", "发放补贴成功", "info");
                $('#save').hide();
            });
        });

        function hqgj(id) {
            
            Ajax(true, global.sys["GetUserOfDepart"], { LoginID: LocalID, depart_id: id }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#gj').text(data.Ex);
            });
        }
        function hqyff(id) {

            Ajax(true, global.xf["GetXFSubsidyGrantEx"], { LoginID: LocalID, id: id, subsidy_granted: 1 }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#yff').text(data.Ex);
            });
        }

        function loaddata() {
            datagrid2.datagrid('unselectAll');
            Ajax(true, global.xf["GetXFSubsidyGrantList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jsondata2.rows = data.Data;
                datagrid2.datagrid('loadData', jsondata2);

            });
        }


    </script>
    <div class="easyui-layout">
        <div>
            <div class="easyui-panel" data-options="region:'north',split:true,collapsible:false"
                style="width: 100%; height: 200px; padding: 5px 0 0;" title="补贴发放 ">
                <table style="margin-left: 20px" cellpadding="1px" cellspacing="5px" border="0px">
                    <tr>
                        <th>
                            部门：
                        </th>
                        <td>
                            <select id="department" class="easyui-combobox" style="width: 106px">
                            </select>
                        </td>
                        <th>
                            补贴金额：
                        </th>
                        <td>
                           <input id="subsidy_money" class="easyui-textbox" style="width: 100px;"  />
                        </td>

                    </tr>
                    <tr>
                        <th>
                            补贴名称：
                        </th>
                        <td>
                            <select id="btmonth" class="easyui-combobox" style="width: 106px;">
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            此部门共计：
                        </th>
                        <td>
                            <div id="gj"></div>
                        </td>
                        <th>
                            人
                        </th>
                    </tr>
                    <tr>
                        <th>
                            补贴已发放：
                        </th>
                        <td>
                            <div id="yff"></div>
                        </td>
                        <th>
                            人
                        </th>
                    </tr>
                </table>
                <table style="margin-left: 20px" cellpadding="1px" cellspacing="5px">
                    <tr>
                        <td align="right">
                            <a href="javascript:void(0)" class="easyui-linkbutton" id="ff" data-options="iconCls:'icon-edit'"
                                style="width: 80px;">发放</a>
                        </td>
                        <td align="right">
                            <a href="javascript:void(0)" class="easyui-linkbutton" id="save" data-options="iconCls:'icon-save'"
                                style="width: 80px;">保存</a>
                        </td>
                        <td align="right">
                            <a href="javascript:void(0)" class="easyui-linkbutton" id="clear" data-options="iconCls:'icon-clear'"
                                style="width: 80px;">重置</a>
                        </td>
                    </tr>
                </table>
            </div>
            <div data-options="region:'center'" style="padding: 2px; width: 100%;">
                <table id="dg" class="easyui-datagrid">
                </table>
            </div>
        </div>
    </div>
</body>
</html>
