<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>	
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css"/>
	<link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>	
       <style type="text/css" >
body {
font-family: verdana,helvetica,arial,sans-serif,宋体;
font-size: 12px;
margin: 0;
padding: 2px;
}
</style>
<script type="text/javascript">
    var LocalID = $.cookie("LocalID");
    var datagrid;
    var jsondata = { "total": 0, "rows": [] };
    var Djsondata = { "total": 0, "rows": [] };
    var Ejsondata = { "total": 0, "rows": [] };
    var datagrid2;
    var jsondata2 = { "total": 0, "rows": [] };
    var ww;
    var datagrid1;
    var jsondata1 = { "total": 0, "rows": [] };
    var datagrid3;
    var jsondata3 = { "total": 0, "rows": [] };

    var editRow = undefined;
    var editRow1 = undefined;
    var editRow2 = undefined;
    $(function () {
        Ajax(true, global.sys["GetAllDepartUserTree"], { LoginID: LocalID, iconUls: 'icon-man', iconCls: 'icon-tool', iconCls1: 'icon-house', root: '0' }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            $('#ren').combotree({
                data: JSON2.parse(data.Data),
                editable: false,
                onSelect: function (node) {
                    //返回树对象  
                    var tree = $(this).tree;
                    //选中的节点是否为叶子节点,如果不是叶子节点,清除选中  
                    var isLeaf = tree('isLeaf', node.target);
                    if (!isLeaf) {
                        //清除选中  
                        $('#ren').combotree("setValue","");
                    }
                }
            });
        });
        Ajax(true, global.xg["GetXGWindowList"], { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            $('#xjd').combobox({
                data: data.Data,
                valueField: "window_num",
                textField: "window_name",
                editable: false
            });
           
        });
        Ajax(true, global.xg["GetXGMngRoadList"], { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata.rows = data.Data; 
            $('#xlm').combobox({
                data: data.Data,
                valueField: "id",
                textField: "road_name",
                editable: false
            });
            $('#xl1').combobox({
                data: data.Data,
                valueField: "id",
                textField: "road_name",
                editable: false
            });
            $('#xl2').combobox({
                data: data.Data,
                valueField: "id",
                textField: "road_name",
                editable: false
            });
        });
        datagrid = $("#dg").datagrid({
            idField: "id",
            fitColumns: true,
            striped: true,
            title: "",
            collapsible: true,
            remotesort: false,
            rownumbers: true,
            singleSelect: true,
            columns: [[{
                field: 'road_name',
                title: '线路名',
                //                sortable: true,
                width: 80
            }]],
            onLoadSuccess: function (data) {
                //默认选中第一行
                $(this).datagrid('selectRow', 0);
            },
            onSelect: function (rowIndex, rowData) {
                loaddata1(rowData.id);
                loaddata2(rowData.id);
                loaddata3(rowData.id);

            }
        });
        datagrid1 = $("#dg1").datagrid({
            idField: "id",
            fitColumns: true,
            striped: true,
            title: "",
            collapsible: true,
            remotesort: false,
            rownumbers: true,
            columns: [[{
                field: 'road_name',
                title: '线路名',
                //                sortable: true,
                width: 80
            }, {
                //                field: 'mach_id',
                //                title: '巡检点号',
                //                //                sortable: true,
                //                width: 80,

                //                editor: { type: 'textbox', options: { editable: false} }
                //            }, {
                field: 'window_name',
                title: '巡检点名',
                //                sortable: true,
                width: 80
            }]],
            toolbar: [{
                text: "删除", iconCls: "icon-remove", handler: function () {
                    var rowData = datagrid1.datagrid('getSelections');
                    var group_name = rowData.group_name;
                    var ids;
                    if (rowData == null || rowData.length == 0) {
                        $.messager.alert("提示", "未选择项", "error");
                        return;
                    }
                    $.messager.confirm("提示", "确定要删除所选项？", function (data) {
                        if (data) {
                            for (var i = 0; i < rowData.length; i++) {
                                ids = rowData[i].id;
                                Ajax(true, global.xg["RemoveXGRoadMach"], { LoginID: LocalID, id: ids }, function (data) {
                                    if (!data.Success) {
                                        alert(data.Message);
                                        return;
                                    }

                                    loaddata1(datagrid.datagrid('getSelected').id);
                                });
                            }
                            $.messager.alert("提示", "删除成功", "info");
                        }
                    });
                }
            }, {
                text: "增加", iconCls: "icon-add", handler: function () {

                    $('#win1').window('open');
                    var row = datagrid.datagrid('getSelected');
                    $("#xl1").combobox("setValue", row.id);
                    $("#xjd").combobox("setValue", "");
                }
            

            }]
        });
       
        datagrid2 = $("#dg2").datagrid({
            idField: "id",
            fitColumns: true,
            striped: true,
            title: "",
            collapsible: true,
            remotesort: false,
            rownumbers: true,
            columns: [[{
                field: 'road_name',
                title: '线路名',
                //                sortable: true,
                width: 60
            }, {
                field: 'set_time',
                title: '巡检时间',
                //                sortable: true,
                width: 60

            }, {
                field: 'begin_time',
                title: '开始时间',
                //                sortable: true,
                width: 60
            }, {
                field: 'end_time',
                title: '结束时间',
                //                sortable: true,
                width: 60
            }, {
                field: 'day',
                title: '星期几执行',
                //                sortable: true,
                width: 150,
                formatter: function (val, rec) {
                    var you = "";
                    if (rec.monday == "1") {
                        you += "一";
                    }
                    if (rec.tuesday == "1") {
                        if (you != "") {
                            you += "、";
                        }
                        you += "二";
                    }
                    if (rec.wednesday == "1") {
                        if (you != "") {
                            you += "、";
                        }
                        you += "三";
                    }
                    if (rec.thursday == "1") {
                        if (you != "") {
                            you += "、";
                        }
                        you += "四";
                    }
                    if (rec.friday == "1") {
                        if (you != "") {
                            you += "、";
                        }
                        you += "五";
                    }
                    if (rec.saturday == "1") {
                        if (you != "") {
                            you += "、";
                        }
                        you += "六";
                    }
                    if (rec.sunday == "1") {
                        if (you != "") {
                            you += "、";
                        }
                        you += "日";
                    }
                    return you;
                }
            }]],
            toolbar: [{
                text: "删除", iconCls: "icon-remove", handler: function () {
                    var rowData = datagrid2.datagrid('getSelections');
                    var group_name = rowData.group_name;
                    var ids;
                    if (rowData == null || rowData.length == 0) {
                        $.messager.alert("提示", "未选择项", "error");
                        return;
                    }
                    $.messager.confirm("提示", "确定要删除所选项？", function (data) {
                        if (data) {
                            for (var i = 0; i < rowData.length; i++) {
                                ids = rowData[i].id;
                                Ajax(true, global.xg["RemoveXGRoadTime"], { LoginID: LocalID, id: ids }, function (data) {
                                    if (!data.Success) {
                                        alert(data.Message);
                                        return;
                                    }

                                    loaddata2(datagrid.datagrid('getSelected').id);
                                });
                            }
                            $.messager.alert("提示", "删除成功", "info");
                        }
                    });
                }
            }, {
                text: "增加", iconCls: "icon-add", handler: function () {

                    $('#win').window('open');
                    $("#xlm").combobox("setValue", "");
                    $('#st').timespinner('setValue', '09:00');
                    $('#bt').timespinner('setValue', '08:50');
                    $('#et').timespinner('setValue', '09:10');
                    $("#one").prop('checked', true);
                    $("#two").prop('checked', true);
                    $("#three").prop('checked', true);
                    $("#four").prop('checked', true);
                    $("#five").prop('checked', true);
                    $("#six").prop('checked', false);
                    $("#sun").prop('checked', false);
                    editRow2 = 0;
                }
            }, {
                text: "修改", iconCls: "icon-edit", handler: function () {
                    $('#win').window('open');
                    var row = datagrid2.datagrid('getSelected');
                    if (row == null) {
                        $.messager.alert("提示", "未选择项", "error");
                        return;
                    }
                    $("#xlm").combobox("setValue", row.road_id);
                    $('#st').timespinner('setValue', row.set_time);
                    $('#bt').timespinner('setValue', row.begin_time);
                    $('#et').timespinner('setValue', row.end_time);
                    if (row.monday == 1) {
                        $("#one").prop('checked', true);
                    }
                    else { $("#one").prop('checked', false); }
                    if (row.tuesday == 1) {
                        $("#two").prop('checked', true);
                    }
                    else { $("#two").prop('checked', false); }
                    if (row.wednesday == 1) {
                        $("#three").prop('checked', true);
                    }
                    else { $("#three").prop('checked', false); }
                    if (row.thursday == 1) {
                        $("#four").prop('checked', true);
                    }
                    else { $("#four").prop('checked', false); }
                    if (row.friday == 1) {
                        $("#five").prop('checked', true);
                    }
                    else { $("#five").prop('checked', false); }
                    if (row.saturday == 1) {
                        $("#six").prop('checked', true);
                    }
                    else { $("#six").prop('checked', false); }
                    if (row.sunday == 1) {
                        $("#sun").prop('checked', true);
                    }
                    else { $("#sun").prop('checked', false); }
                    editRow2 = 1;
                }

            }],
            onDblClickRow: function (rowIndex, rowData) {
                $('#win').window('open');
                $("#xlm").combobox("setValue", rowData.road_id);
                $('#st').timespinner('setValue', rowData.set_time);
                $('#bt').timespinner('setValue', rowData.begin_time);
                $('#et').timespinner('setValue', rowData.end_time);
                if (rowData.monday == 1) {
                    $("#one").prop('checked', true);
                }
                else { $("#one").prop('checked', false); }
                if (rowData.tuesday == 1) {
                    $("#two").prop('checked', true);
                }
                else { $("#two").prop('checked', false); }
                if (rowData.wednesday == 1) {
                    $("#three").prop('checked', true);
                }
                else { $("#three").prop('checked', false); }
                if (rowData.thursday == 1) {
                    $("#four").prop('checked', true);
                }
                else { $("#four").prop('checked', false); }
                if (rowData.friday == 1) {
                    $("#five").prop('checked', true);
                }
                else { $("#five").prop('checked', false); }
                if (rowData.saturday == 1) {
                    $("#six").prop('checked', true);
                }
                else { $("#six").prop('checked', false); }
                if (rowData.sunday == 1) {
                    $("#sun").prop('checked', true);
                }
                else { $("#sun").prop('checked', false); }
                editRow2 = 1;

            }
        });
        $("#close").click(function () {
            $('#win').window('close');
        });
        $("#A1").click(function () {
            $('#win1').window('close');
        });
        $("#A2").click(function () {

            var row = datagrid.datagrid('getSelected');
            var hd = $("#xl1").combobox("getValue");
            var hk = $("#xjd").combobox("getValue");
            if (hd == "") {
                $.messager.alert("提示", "巡检线路不能为空", "error");
                return;
            }
            if (hk == "") {
                $.messager.alert("提示", "巡检点不能为空", "error");
                return;
            }
            Ajax(true, global.xg["NewXGRoadMach"], { LoginID: LocalID, road_id: hd, mach_id: hk }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $.messager.alert("提示", "保存成功", "info");
                loaddata1(datagrid.datagrid('getSelected').id);
                $('#win1').window('close');
            });
        });
        $("#A3").click(function () {
            $('#win2').window('close');
        });
        $("#save").click(function () {
            var xl = $('#xlm').combobox("getValue");
            var st = $('#st').timespinner('getValue');
            var bt = $('#bt').timespinner('getValue');
            var et = $('#et').timespinner('getValue');
            var one;
            var two;
            var three;
            var four;
            var five;
            var six;
            var sun;
            if (xl == "") {
                alert("线路名不能为空！");
                return;
            }
            if (st == "") {
                alert("巡检时间不能为空！");
                return;
            }
            if (bt == "") {
                alert("开始时间不能为空！");
                return;
            }
            if (et == "") {
                alert("结束时间不能为空！");
                return;
            }
            if ($("#one").is(":checked")) {
                one = "1";
            }
            else {
                one = "0";
            }
            if ($("#two").is(":checked")) {
                two = "1";
            }
            else {
                two = "0";
            }
            if ($("#three").is(":checked")) {
                three = "1";
            }
            else {
                three = "0";
            }
            if ($("#four").is(":checked")) {
                four = "1";
            }
            else {
                four = "0";
            }
            if ($("#five").is(":checked")) {
                five = "1";
            }
            else {
                five = "0";
            }
            if ($("#six").is(":checked")) {
                six = "1";
            }
            else {
                six = "0";
            }
            if ($("#sun").is(":checked")) {
                sun = "1";
            }
            else {
                sun = "0";
            }
            if (editRow2 == 0) {
                Ajax(true, global.xg["NewXGRoadTime"], { LoginID: LocalID, road_id: xl, set_time: st, begin_time: bt, end_time: et, monday: one, tuesday: two, wednesday: three, thursday: four, friday: five, saturday: six, sunday: sun }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    $.messager.alert("提示", "保存成功", "info");
                    loaddata2(datagrid.datagrid('getSelected').id);
                    $('#win').window('close');
                });
                editRow2 = undefined;
            }
            if (editRow2 == 1) {
                var row = datagrid2.datagrid('getSelected');
                var id = row.id;
                Ajax(true, global.xg["UpdateXGRoadTime"], { LoginID: LocalID, id: id, road_id: xl, set_time: st, begin_time: bt, end_time: et, monday: one, tuesday: two, wednesday: three, thursday: four, friday: five, saturday: six, sunday: sun }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    $.messager.alert("提示", "保存成功", "info");
                    loaddata2(datagrid.datagrid('getSelected').id);
                    $('#win').window('close');
                });
                editRow2 = undefined;
            }
        });
        $("#A4").click(function () {
                var dd = $("#xl2").combobox("getValue");
                var dk = $("#ren").combotree("getValue");
                if (dd == "") {
                    $.messager.alert("提示", "巡检线路不能为空", "error");
                    return;
                }
                if (dk == "") {
                    $.messager.alert("提示", "人员姓名不能为空", "error");
                    return;
                }
                Ajax(true, global.xg["NewXGRoadUser"], { LoginID: LocalID, road_id: dd, user_file: dk }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    $.messager.alert("提示", "保存成功", "info");
                    $('#win2').window('close');
                    loaddata3(datagrid.datagrid('getSelected').id);
                });
        });
        datagrid3 = $("#dg3").datagrid({
            idField: "id",
            fitColumns: true,
            striped: true,
            title: "",
            collapsible: true,
            remotesort: false,
            rownumbers: true,
            columns: [[{
                field: 'road_name',
                title: '线路名',
                //                sortable: true,
                width: 80
            }, {
                field: 'user_name',
                title: '人员姓名',
                //                sortable: true,
                width: 80
            }]],
            toolbar: [{
                text: "删除", iconCls: "icon-remove", handler: function () {
                    var rowData = datagrid3.datagrid('getSelections');
                    var ids;
                    if (rowData == null || rowData.length == 0) {
                        $.messager.alert("提示", "未选择项", "error");
                        return;
                    }
                    $.messager.confirm("提示", "确定要删除所选项？", function (data) {
                        if (data) {
                            for (var i = 0; i < rowData.length; i++) {
                                ids = rowData[i].id;
                                Ajax(true, global.xg["RemoveXGRoadUser"], { LoginID: LocalID, id: ids }, function (data) {
                                    if (!data.Success) {
                                        alert(data.Message);
                                        return;
                                    }

                                    loaddata3(datagrid.datagrid('getSelected').id);
                                });
                            }
                            $.messager.alert("提示", "删除成功", "info");
                        }
                    });
                }
            }, {
                text: "增加", iconCls: "icon-add", handler: function () {
                    var roww = datagrid.datagrid('getSelected');
                    $('#win2').window('open');
                    $("#xl2").combobox("setValue", roww.id);
                }
           
            }]
        });
        loaddata();
        $('#win').window('close');
        $('#win1').window('close');
        $('#win2').window('close');
    });
    function loaddata() {
        datagrid.datagrid('unselectAll');
        Ajax(true, global.xg["GetXGMngRoadList"], { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata.rows = data.Data;
            datagrid.datagrid('loadData', jsondata);
        });
    }
    function loaddata1(ida) {
        datagrid1.datagrid('unselectAll');
        var row = datagrid.datagrid('getSelected');
        Ajax(true, global.xg["GetXGRoadMachList"], { LoginID: LocalID, road_id: ida }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata1.rows = data.Data;
            datagrid1.datagrid('loadData', jsondata1);
        });
    }
    function loaddata2(idc) {
        datagrid2.datagrid('unselectAll');
        var row = datagrid.datagrid('getSelected');
        Ajax(true, global.xg["GetXGRoadTimeList"], { LoginID: LocalID, road_id: idc }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata2.rows = data.Data;
            datagrid2.datagrid('loadData', jsondata2);
        });
    }
    function loaddata3(idb) {
        datagrid3.datagrid('unselectAll');
        var row = datagrid.datagrid('getSelected');
        Ajax(true, global.xg["GetXGRoadUserList"], { LoginID: LocalID, road_id: idb }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata3.rows = data.Data;
            datagrid3.datagrid('loadData', jsondata3);
        });
    }
</script>
</head>
<body>
<div class="easyui-layout" data-options="fit:true,maximized:true">
    <div data-options="region:'west',collapsible:false,iconCls:'icon-search'" title=""style="width:200px; ">
		<table id="dg"style="width:100%; " ></table>
	</div>
<div data-options="region:'center'" style="width:60px">
<div id="t" class="easyui-tabs" style="width:100%;">  
    <div title="巡检点设置" data-options="" style="" >  
        <table id="dg1"></table>
    </div>  
    <div title="巡检时间设置" data-options=""style="">  
        <table id="dg2"></table>
    </div>  
    <div title="巡检人员设置" data-options=""style="">  
        <table id="dg3"></table>
    </div>  
  </div> 

</div>
</div>
<div id="win" class="easyui-window" title="巡检时间" data-options="iconCls:'icon-save',maximizable: false,minimizable: false" style="width:300px;height:320px;padding:5px;">
	<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'center'" style="padding:10px;">
        <table cellpadding="5">
			<tr>
				<td>线路名：</td>
				<td><select id="xlm" class="easyui-combobox" style="width:120px"></select></td>
			</tr>
			<tr>
				<td>巡检时间：</td>
				<td><input id="st" class="easyui-timespinner"  style="width:120px;"  
        required="required" data-options="" /> </td>
			</tr>
			<tr>
				<td>开始时间:</td>
				<td><input id="bt" class="easyui-timespinner"  style="width:120px;"  
        required="required" data-options="" /> </td>
			</tr>
			<tr>
				<td>结束时间:</td>
				<td><input id="et" class="easyui-timespinner"  style="width:120px;"  
        required="required" data-options="" /> </td>
			</tr>
			<tr>
				<td>星期:</td>
				<td><input type="checkbox" name="week" id="one" />一<input type="checkbox" name="week" id="two"/>二<input type="checkbox" name="week" id="three" />三
                <input type="checkbox" name="week" id="four" />四</td></tr>
                <tr>
                <td></td>
                <td><input type="checkbox" name="week" id="five"/>五<input type="checkbox" name="week" id="six" />六
                <input type="checkbox" name="week" id="sun" />日</td>
			</tr>
		</table>
			
		</div>
		<div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
			<a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" id="close" style="width:80px">关闭</a>
			<a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" id="save" style="width:80px">提交</a>
		</div>
	</div>
</div>
<div id="win1" class="easyui-window" title="巡检点" data-options="iconCls:'icon-save',maximizable: false,minimizable: false" style="width:300px;height:220px;padding:5px;">
	<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'center'" style="padding:10px;">
        <table cellpadding="5">
			<tr>
				<td>线路名：</td>
				<td><select id="xl1" class="easyui-combobox" style="width:120px"></select></td>
			</tr>
			<tr>
				<td>巡检点：</td>
				<td><select id="xjd" class="easyui-combobox" style="width:120px"></select> </td>
			</tr>
			
		</table>
			
		</div>
		<div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
			<a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" id="A1" style="width:80px">关闭</a>
			<a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" id="A2" style="width:80px">提交</a>
		</div>
	</div>
</div>
<div id="win2" class="easyui-window" title="巡检人员" data-options="iconCls:'icon-save',maximizable: false,minimizable: false" style="width:300px;height:220px;padding:5px;">
	<div class="easyui-layout" data-options="fit:true">
		<div data-options="region:'center'" style="padding:10px;">
        <table cellpadding="5">
			<tr>
				<td>线路名：</td>
				<td><select id="xl2" class="easyui-combobox" style="width:120px"></select></td>
			</tr>
			<tr>
				<td>巡检人员：</td>
				<td><select id="ren" class="easyui-combotree" style="width:120px"></select> </td>
			</tr>
			
		</table>
			
		</div>
		<div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
			<a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" id="A3" style="width:80px">关闭</a>
			<a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" id="A4" style="width:80px">提交</a>
		</div>
	</div>
</div>
</body>
</html>
