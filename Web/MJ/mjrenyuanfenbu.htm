<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>	
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css"/>
	<link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>	
</head>
 <style type="text/css" >
body {
font-family: verdana,helvetica,arial,sans-serif,宋体;
font-size: 12px;
margin: 0;
padding: 2px;
}
</style>
<script type="text/javascript">
    var LocalID = $.cookie("LocalID");
    var datagrid;
    var doordivHTML = "";
    var chang;
    var rool;
    var status = 0;
    var dataURL;
    var datagrid1;
    var datagrid2;
    var CTLDIV = null;
    var dataURL;
    var jrenshu;
    var crenshu;
    var jsondata = { "total": 0, "rows": [] };
    var jsondata1 = { "total": 0, "rows": [] };
    var jsondata2 = { "total": 0, "rows": [] };
    var sortName = "id";
    var sortOrder = "asc";
    var PageSize = 10;
    var PageNum = 1;
    $(function () {
        Ajax(true, global.mj["GetMJWhereGroupList"], { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            $('#qy').combobox({
                data: data.Data,
                valueField: 'address_group_id',
                textField: 'address_group',
                onLoadSuccess: function () {
                    var data = $('#qy').combobox('getData');
                    $("#qy").combobox('select', data[0].address_group_id);
                },
                onChange: function (newValue, oldValue) {
                    loaddata(newValue);
                    ChickClient();
                    Ajax(true, global.mj["GetMJWhereGroup"], { LoginID: LocalID, address_group_id: newValue }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        var beijing = data.Data.pic_name;
                        if (beijing == null || beijing == "") {
                            document.getElementById("tu").src = "../../Images/pzcard_pzbz.gif";
                        }
                        else {
                            document.getElementById("tu").src = "../../Picture/" + beijing + "" ;
                        }
                    });
                }
            });
        });
        datagrid1 = $("#dg1").datagrid({
            idField: "id",
            fitColumns: true,
            striped: true,
            title: "进入人员",
            collapsible: false,
            remotesort: false,
            rownumbers: true,
            singleSelect: true,
            sortName: sortName,
            sortOrder: sortOrder,
            columns: [[{
                field: 'id',
                title: '编号',
                //                sortable: true,
                width: 40,
                sortable: true
            }, {
                field: 'user_name',
                title: '姓名',
                width: 80,
                sortable: true

            }]],
            //排列行
            onSortColumn: function (sort, order) {
                sortName = sort;
                sortOrder = order;
                loaddata1();
            }
        });
        datagrid2 = $("#dg2").datagrid({
            idField: "id",
            fitColumns: true,
            striped: true,
            title: "外出人员",
            collapsible: false,
            remotesort: false,
            rownumbers: true,
            singleSelect: true,
            sortName: sortName,
            sortOrder: sortOrder,
            columns: [[{
                field: 'id',
                title: '编号',
                //                sortable: true,
                width: 40,
                sortable: true
            }, {
                field: 'user_name',
                title: '姓名',
                width: 80,
                sortable: true

            }]],
            //排列行
            onSortColumn: function (sort, order) {
                sortName = sort;
                sortOrder = order;
                loaddata2();
            }
        });
        $('#win').window('close');
    });
    function renyuanchakan(dd) {
        loaddata1(dd.id);
        loaddata2(dd.id);
        $('#win').window('open');
    }
    function loaddata(id) {
        var divHTML = "";
        var clientWidth = document.body.clientWidth;
        var clientHeight = document.body.clientHeight;
        var k = clientWidth / 10;
        Ajax(true, global.mj["GetMJControlDoorList"], { LoginID: LocalID, address_group_id: id }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            chang = data.Data;
            if (chang != undefined) {
                for (var i = 0; i < chang.length; i++) {
                    var ids = chang[i].id;
                    (function (ids) {
                        var x = chang[i].pointx;
                        var y = chang[i].pointy;
                        var px = Math.round(x * clientWidth / 10000);
                        var py = Math.round(y * clientHeight / 10000);
                        divHTML += "<div id='" + chang[i].id + "' draggable='true' disable='false' style='top:";
                        if (x == "" || y == "") { divHTML += "0px; left:0px;z-index:129;width:20px; height:20px;display: inline;position:absolute;className:easyui-draggable; background-image:"; }
                        else { divHTML += (py - 20) + "px; left:" + px + "px;z-index:129;width:20px; height:20px;display: inline;position:absolute; className:easyui-draggable; background-image:"; }
                        if (chang[i].door_status == "1") {
                            divHTML += "url(../../Images/dooropenmin.gif);";
                        }
                        else {
                            divHTML += "url(../../Images/doorclosemin.gif);";
                        }
                        divHTML += " 'onclick='renyuanchakan(this);'";
                        divHTML += "></div>";
                    })(ids)
                }
                if (divHTML != doordivHTML) {
                    doordivHTML = divHTML;
                    var doordiv = document.getElementById("doordiv");
                    doordiv.innerHTML = doordivHTML;
                    jilu();
                }
            }
        });
    }
    function jilu() {
        for (var i = 0; i < chang.length; i++) {
            var id = chang[i].id;
            Ajax(true, global.mj["GetMjUserWherePageList"], { LoginID: LocalID, door_id: id, kind: "0", sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jrenshu = data.Ex;
                Ajax(true, global.mj["GetMjUserWherePageList"], { LoginID: LocalID, door_id: id, kind: "1", sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    crenshu = data.Ex;
                    document.getElementById(id).title = "进入人数：" + jrenshu + " || " + "外出人数：" + crenshu;
                });
            });
        }
    }
    var rool;
    function loaddata1(did) {
        clearTimeout(rool); 
        Ajax(true, global.mj["GetMjUserWherePageList"], { LoginID: LocalID, door_id: did, kind: "0", sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jrenshu = data.Ex;
            jsondata1.total = data.Ex;
            jsondata1.rows = data.Data;
            datagrid1.datagrid('loadData', jsondata1);
            if (jsondata1.total == 0) {
                PageNum = 1;
            }
            var p = datagrid1.datagrid('getPager');
            $(p).pagination({
                beforePageText: '第', //页数文本框前显示的汉字 
                afterPageText: '页    共 ' + Math.ceil(jsondata1.total / PageSize) + ' 页',
                displayMsg: '当前显示 ' + (PageSize * (PageNum - 1) + (jsondata1.total == 0 ? 0 : 1)) + ' - ' + (PageSize * (PageNum - 1) + data.Data.length) + ' 条记录   共 ' + jsondata1.total + ' 条记录',
                onSelectPage: function (pageNumber, pageSize) {
                    PageSize = pageSize;
                    PageNum = pageNumber;
                    if (PageNum < 1) {
                        PageNum = 1;
                    }
                    loaddata1(did);
                }
            });
            rool = setTimeout(function () { loaddata1(did); }, 10000);
        });
    }
    var rools;
    function loaddata2(did) {
        clearTimeout(rools); 
        Ajax(true, global.mj["GetMjUserWherePageList"], { LoginID: LocalID, door_id: did, kind: "1", sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            crenshu = data.Ex;
            jsondata2.total = data.Ex;
            jsondata2.rows = data.Data;
            datagrid2.datagrid('loadData', jsondata2);
            if (jsondata2.total == 0) {
                PageNum = 1;
            }
            var p = datagrid2.datagrid('getPager');
            $(p).pagination({
                beforePageText: '第', //页数文本框前显示的汉字 
                afterPageText: '页    共 ' + Math.ceil(jsondata2.total / PageSize) + ' 页',
                displayMsg: '当前显示 ' + (PageSize * (PageNum - 1) + (jsondata2.total == 0 ? 0 : 1)) + ' - ' + (PageSize * (PageNum - 1) + data.Data.length) + ' 条记录   共 ' + jsondata2.total + ' 条记录',
                onSelectPage: function (pageNumber, pageSize) {
                    PageSize = pageSize;
                    PageNum = pageNumber;
                    if (PageNum < 1) {
                        PageNum = 1;
                    }
                    loaddata2(did);
                }
            });
            rools = setTimeout(function () { loaddata2(did); }, 10000);
        });
    }
    function ChickClient() {
        var Max = document.getElementById("Max");
        var MaxHTML = "MAX:" + document.body.clientWidth + "*" + document.body.clientHeight;
        if (Max.innerHTML != MaxHTML) {
            Max.innerHTML = MaxHTML;
        }
    }

    function mousePosition(ev) {
        if (ev.pageX || ev.pageY) {
            return { x: ev.pageX, y: ev.pageY };
        }
        return {
            x: ev.clientX + document.body.scrollLeft - document.body.clientLeft,
            y: ev.clientY + document.body.scrollTop - document.body.clientTop
        };
    }
    function GetXY(ev) {
        var Pos = document.getElementById("Pos");
        if (document.all) { ev = window.event; }
        var mousePos = mousePosition(ev);
        if (window.event) { ev.returnValue = false; }
        Pos.innerHTML = "POS:" + mousePos.x + "*" + mousePos.y;
        if (CTLDIV != null) {
            var x = mousePos.x - POSXY.x;
            var y = mousePos.y - POSXY.y;
            var left = (XY.x + x);
            var top = (XY.y + y);
            if (left < 0 || top < 0) {
                return;
            }
            var clientWidth = document.body.clientWidth;
            var clientHeight = document.body.clientHeight;
            if (left > (clientWidth - 22) || top > (clientHeight - 22)) {
                return;
            }
            CTLDIV.style.left = left + "px";
            CTLDIV.style.top = top + "px";
        }
    }
</script>
<body id="ibody" onmousemove="GetXY(event);">
<div class="easyui-layout" data-options="fit:true">
<div data-options="region:'north',collapsible:false" title=""style="padding:0px;z-index: 9; position: relative; ">
区域：<select id="qy" class="easyui-combobox"  style="width:100px;height:20px"></select>
    </div>
    <div id="biao" data-options="region:'west',collapsible:false" title=""style="padding:0px;width:100%; z-index: 9; position: relative;">
    <img id="tu" width="100%" height="100%" style="z-index: 11; position: absolute;"/>
    <div id="doordiv" style="z-index: 99;width:100%;height:100%; position: relative;" >
    </div>
     <div id="ID" style="top:0px; left:0px;z-index:119; position:absolute;">ID:001</div>
     <div id="Max" style="top:0px; left:60px;z-index:119; position:absolute;"></div>
     <div id="Pos" style="top:0px; left:180px;z-index:119; position:absolute;"></div>
	</div> 
	</div>
    <div id="win" class="easyui-window" title="进出人员" data-options="iconCls:'icon-save',minimizable:false,maximizable:false" style="width:550px;height:450px;">
	<div class="easyui-layout" data-options="fit:true">
       <div data-options="region:'west'" style="width:50%;">
       <table id="dg1"style="width:100%; "data-options="pagination:true"> </table>
</div>
<div data-options="region:'center'"style="width:50%;">
<table id="dg2"style="width:100%; "data-options="pagination:true"> </table>
</div>
		
</div>
</div>
</body>
</html>
