<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/scene_co_ch.js" type="text/javascript"></script>
    <script src="../../Scripts/constant.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <style type="text/css">
        body
        {
            font-family: verdana,helvetica,arial,sans-serif,宋体;
            font-size: 12px;
            margin: 0;
            padding: 20px;
        }
    </style>
    <script type="text/javascript">
        var getMaxId = function () {
            Ajax(true, global.mj["GetNowEventRecorderMjMaxID"], { LoginID: LocalID
            }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                maxId = data.Data;
                loaddata();
            });
        };
        //初始化表格
        function iniGrid() {
            datatable = $("#tbInfo").datagrid({
                idField: "id",
                fit: true //自动补全
            });
        };
        //获取所有数据
        function loaddata() {
            var inOutNull = undefined;
            if (maxId < 0) {
                return;
            }
            Ajax(true, global.mj["GetNowEventRecorderMjPageList"], { LoginID: LocalID, id: maxId, event_reason: inOutNull, sortName: 'id', sortOrder: true, pageSize: 20, pageNum: 1
            }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                //                  datatable.datagrid('insertRow', {
                //                                    index: 0,
                //                                    row: {
                //                                        user_name: index,
                //                                        what_do: 'T3',
                //                                        event_date: '2015-01-12 15:34:45'
                //                                    }
                //                                });
                //                                index++;
                //将id值赋给最大值
                if (data.Data.length && data.Data.length != 0) {
                    for (var i = 0; i < data.Data.length; i++) {
                        if (data.Data[i].id > parseInt(maxId)) {
                            maxId = data.Data[i].id;
                        }
                        datatable.datagrid('insertRow', {
                            index: 0,
                            row: data.Data[i]
                        });
                        index++;
                    }
                }
                if (index > 49) {
                    for (var i = index; i > 49; i--) {
                        datatable.datagrid('deleteRow', i);
                        index--;
                    }
                }
            });
        };
        //获取进出状况
        var getInOutReason = function (val, row) {
            if (eventReasons[row.event_reason]) {
                return eventReasons[row.event_reason];
            } else {
                return '未定义';
            };
        };
        //获取网络状况
        var getNetFlag = function (value, row) {
            if (netFlags[row.net_flag]) {
                return netFlags[row.net_flag];
            } else {
                return '未定义';
            };
        };
    </script>
</head>
<script>
    var LocalID = $.cookie("LocalID");
    var sortName = "event_date";
    var sortOrder = "asc";
    var PageSize = 10;
    var PageNum = 1;
    var jsondata = { "total": 0, "rows": [] };
    var datatable;
    var rool;
    var maxId = -1;
    var id = -1;
    //计算table最大索引
    var index = -1;
</script>
<body>
    <table id='tbInfo' class='easyui-datagrid' data-options="rownumbers:true,singleSelect:true,fitColumns:true,striped:true,pagination:false, collapsible: false,iconCls:'icon-search', pageList: [10, 20, 50, 100],fit:true,"
        title="实时记录">
        <thead>
            <tr>
                <th data-options="field:'user_name',width:'100px', align:'center',sortable:false">
                    姓名
                </th>
                <th data-options="field:'door_name',width:'100px',align:'center',sortable:false">
                    门名
                </th>
                <th data-options="field:'event_date',width:'100px',align:'center',sortable:false">
                    时间
                </th>
                <th data-options="field:'event_cardid',width:'100px',align:'center',sortable:false">
                    卡号
                </th>
                <th data-options="field:'depart_name',width:'100px',align:'center',sortable:false">
                    部门
                </th>
                <th data-options="field:'case_info_id',width:'100px',align:'center',sortable:false,formatter:getInOutReason">
                    状况
                </th>
                <th data-options="field:'net_flag',width:'100px',align:'center',sortable:false,formatter:getNetFlag">
                    类型
                </th>
            </tr>
        </thead>
    </table>
    <script>
        $(function () {
            iniGrid();
            getMaxId();
            setInterval(loaddata, 10000);
        })      
    </script>
</body>
</html>
