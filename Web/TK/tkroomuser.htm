<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title></title>	
<link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css"/>
<link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <link href="../../Scripts/jquery-easyui/themes/IconExtension.css" rel="stylesheet"
        type="text/css" />
<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
<script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
<script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
<script src="../../Scripts/json2.js" type="text/javascript"></script>
<script src="../../Scripts/global.js" type="text/javascript"></script>
<script src="../../Scripts/common.js" type="text/javascript"></script>	
<style type="text/css" >
body {
font-family: verdana,helvetica,arial,sans-serif,宋体;
font-size: 12px;
margin: 0;
padding: 20px;
}
.style6
{
    width: 207px;
}
.style8
{
    width: 73px;
}
.style9
{
    width: 100%;
}
.style10
{
    width: 188px;
}
</style>
<script type="text/javascript">
var LocalID = $.cookie("LocalID");
var tree;
var Rdatagrid;
var datagrid;
var jsondata = { "total": 0, "rows": [] };
var Ljsondata = { "total": 0, "rows": [] };
var Rjsondata = { "total": 0, "rows": [] };
var flag;
$(function () {
    Ajax(true, global.tk["GetTkRoomList"], { LoginID: LocalID }, function (data) {
        if (!data.Success) {
            alert(data.Message);
            return;
        }
        $('#select').combobox({
            data: data.Data,
            valueField: 'id',
            textField: 'room_name',
            onChange: function (newValue, oldValue) {
                Rloaddata(newValue);
            }
        });
    });
    datagrid = $("#dg1").datagrid({
        idField: "user_file",
        fitColumns: true,
        striped: true,
        collapsible: true,
        remotesort: false,
        rownumbers: true,
        columns: [[{
            field: 'user_file',
            title: '编号',
            //                sortable: true,
            width: 80
        }, {
            field: 'user_name',
            title: '用户',
            //                sortable: true,
            width: 80
        }, {
            field: 'room_id',
            title: '房间',
            //                sortable: true,
            width: 80
        }]]
    });
    tree = $("#tt").tree({
        animate: true,
        checkbox: true,
        onSelect: function (node) {
            if (node.attributes.kind == "U") {
            }
            else if (node.attributes && node.attributes.kind && node.attributes.kind == "D") {
                Ljsondata = { "total": 0, "rows": [] };
                treeEvent(node);
            }
        }
//        onBeforeExpand: function (node) {
//            var target = node.children || undefined;
//            if (target && target.length && target.length != 0) {
//                for (var i = 0; i < target.length; i++) {
//                    if (target[i].attributes.kind == "U") {
//                        return;
//                    }
//                }
//            }
//            Ajax(false, global.sys["GetUserTreeOfDepart"], { LoginID: LocalID, depart_id: node.id, iconUls: "icon-man" }, function (data) {
//                XCommon.ClosWating();
//                if (!data.Success) {
//                    alert(data.Message);
//                    return;
//                }
//                $('#tt').tree('append', {
//                    parent: node.target,
//                    data: JSON2.parse(data.Data)
//                });
//            });
//        }
    });
    Lloaddata();
    $('#win').window('close');
    Rdatagrid = $("#dg2").datagrid({
        idField: "user_file",
        fitColumns: true,
        striped: true,
        title: "已分配",
        collapsible: true,
        remotesort: false,
        rownumbers: true,
        SingleSelect: false,
        columns: [[{
            field: 'user_name',
            title: '用户',
            //                sortable: true,
            width: 80
        }]],
        onDblClickRow: function (rowIndex, row) {
            var roomid = $("#select").combobox("getValue");
            var userfile = row.user_file;
            Ajax(true, global.tk["RemoveTkRoomUser"], { LoginID: LocalID, room_id: roomid, user_file: userfile }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                Lloaddata();
                Rloaddata($("#select").combobox("getValue"));
                $.messager.alert("提示", "移出成功", "info");
            });
        }
    });
    $("#moveIn").click(function () {
        var nodes = tree.tree('getChecked');
        var roomid = $("#select").combobox("getValue");
        var roomname = $("#select").combobox("getText");
        if ($("#select").combobox("getValue") == "") {
            $.messager.alert("提示", "房间名不能为空", "error");
            return;

        }
        if (nodes.length == 0) {
            $.messager.alert("提示", "未选中项", "error");
            return;
        }
        $.messager.confirm("提示", "确定分配所选用户"+'<font color="red">' + roomname + '</font>'+"房间权限", function (data) {
            if (data) {
                var j = 0;
                var userfile = "";
                for (var i = 0; i < nodes.length; i++) {
                    if (nodes[i].attributes.kind == "U") {
                        if (j != 0) {
                            userfile += "|";
                        }
                        userfile += nodes[i].id;
                        j++;
                    }
                }
                Ajax(true, global.tk["NewTkRoomUser"], { LoginID: LocalID, room_id: roomid, user_file: userfile }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    Lloaddata();
                    Rloaddata($("#select").combobox("getValue"));
                    $.messager.alert("提示", "移入成功", "info");
                });
            }
        });
    });
    $("#moveOut").click(function () {
        if (Rdatagrid.datagrid('getSelections') == null) {
            $.messager.alert("提示", "未选中项", "error");
            return;
        }
        var roomid = $("#select").combobox("getValue");
        var rows = Rdatagrid.datagrid('getSelections');
        for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var userfile = row.user_file;
            Ajax(true, global.tk["RemoveTkRoomUser"], { LoginID: LocalID, room_id: roomid, user_file: userfile }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                Lloaddata();
                Rloaddata($("#select").combobox("getValue"));
                $.messager.alert("提示", "移出成功", "info");
            });
        }
    });
    $("#search").click(function () {
        var text = $("#text").val();
        $('#win').window('open');
        loaddata(text);
    });
});
function Lloaddata() {
    Ajax(true, global.sys.GetAllDepartTree, { LoginID: LocalID, iconCls: 'exicon-house', state: 'closed' }, function (data) {
        if (!data.Success) {
            alert(data.Message);
            return;
        }
        Ljsondata.total = data.Data.length;
        Ljsondata.rows = JSON2.parse(data.Data);
        tree.tree('loadData', Ljsondata.rows);
        if (data.Data.length > 0) {
            if (tree.tree('getSelected') == null) {
                var root = tree.tree("getRoot");
                tree.tree('select', root.target);
            }
        }
    });
}
function Rloaddata(roomid) {
    Rdatagrid.datagrid('unselectAll');
    Ajax(true, global.tk["GetTkRoomUserList"], { LoginID: LocalID, room_id: roomid }, function (data) {
        if (!data.Success) {
            alert(data.Message);
            return;
        }
        Rjsondata.total = data.Data.length;
        Rjsondata.rows = data.Data;
        Rdatagrid.datagrid('loadData', Rjsondata);
    });
}
function treeEvent(node) {
//    var target = node.children || undefined;
//    if (target && target.length && target.length != 0) {
//        for (var i = 0; i < target.length; i++) {
//            if (target[i].attributes.kind == "U") {
//                $('#tt').tree('toggle', node.target);
//                return;
//            }
//        }
//    }
    Ajax(false, global.tk["GetTkNullRoomUserTree"], { LoginID: LocalID, depart_id: node.id, iconCls: 'icon-man'}, function (data) {
        if (!data.Success) {
            alert(data.Message);
            return;
        }
        var da = JSON2.parse(data.Data);
        $('#tt').tree('append', {
            parent: node.target,
            data: da
        });
        $('#tt').tree('toggle', node.target);
    });
}
function loaddata(username) {
    datagrid.datagrid('unselectAll');
    Ajax(true, global.tk["GetTkNullOrIsRoomUserList"], { LoginID: LocalID, user_name: username }, function (data) {
        if (!data.Success) {
            alert(data.Message);
            return;
        }
        jsondata.total = data.Data.length;
        jsondata.rows = data.Data;
        datagrid.datagrid('loadData', jsondata);
    });

}	
</script>

</head>
<body>
<div class="easyui-layout" data-options="fit:true">
<div data-options="region:'north',collapsible:false,border:false" style="padding:2px; " >
房间：<select id="select" class="easyui-combobox"  style="width:100px;">  </select> 
人员：<input id="text" class="easyui-validatebox textbox"style="width:100px;height:20px;"  data-options="" />
<a href="javascript:void(0)" class="easyui-linkbutton" id="search" data-options="iconCls:'icon-search'">查询</a>
<div id="info" style="width:600px;text-align:left; color:Blue; font-weight:bold; font-size:large;"></div>
</div>
    <div data-options="region:'west',collapsible:false,iconCls:'icon-search'" title="人员树"style="padding:2px;width:250px; ">
		<ul id="tt"></ul>
	</div>
<div data-options="region:'center'" style="padding-top:30px; padding-left:12px;width:60px">
<div>
	<a href="javascript:void(0)" class="easyui-linkbutton" style="width:60px; margin-bottom:20px;" id="moveOut" >《 移出</a></div>
	<div><a href="javascript:void(0)" class="easyui-linkbutton" style="width:60px"  id="moveIn">移入 》</a></div>
</div>
<div data-options="region:'east',split:true,collapsible:false" style="width:240px;">
	<table id="dg2" ></table>
</div>
</div>
<div id="win" class="easyui-window" title="人员查找" data-options="iconCls:'icon-save',minimizable:false,maximizable:false" style="width:440px;height:330px;padding:35px;">

    	<table id="dg1" ></table>

</div>
</body>

</html>
