<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/scene_co_ch.js" type="text/javascript"></script>
    <script src="../../Scripts/constant.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <style type="text/css">
        body
        {
            font-family: verdana,helvetica,arial,sans-serif,宋体;
            font-size: 12px;
            margin: 0;
            padding: 20px;
        }
    </style>
    <script type="text/javascript">
        var getTimeTK = function (value, row, index) {
            if (row.case_time != '') {
                return row.case_time.slice(11, 19);
            } else {
                return null;
            }
        };
        var getFlagTK = function (value, row, index) {
            var img = '<img src=';
            if (row.flag == '00') {
                img += "../../Scripts/jquery-easyui/themes/icons/ok.png />";
            } else {
                img += "../../Scripts/jquery-easyui/themes/icons/no.png />";
            }
            return img;
        };
        var getNetFlagTK = function (value, row, index) {
            if (row.net_flag == 1) {
                return "联网";
            } else if (row.net_flag == 0) {
                return "脱网";
            } else if (row.net_flag == "") {
                return "无数据";
            } else {
                return "未定义";
            }
        }
        var getMaxId = function () {
            Ajax(true, tk["MaxIDTkRecord"], { LoginID: LocalID
            }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                maxId = data.Data;
                loaddata();
            });
        };
        //初始化表格
        function iniGrid() {
            datatable = $("#tbInfo").datagrid({
                idField: "id",
                fit: true //自动补全
            });
        };
        //获取所有数据
        function loaddata() {
            var inOutNull = undefined;
            if (maxId < 0) {
                return;
            }
            Ajax(true, tk["GetTkRecordPageList"], { LoginID: LocalID, id: maxId, event_reason: inOutNull, sortName: 'id', sortOrder: true, pageSize: 20, pageNum: 1
            }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                //                  datatable.datagrid('insertRow', {
                //                                    index: 0,
                //                                    row: {
                //                                        user_name: index,
                //                                        what_do: 'T3',
                //                                        event_date: '2015-01-12 15:34:45'
                //                                    }
                //                                });
                //                                index++;
                //将id值赋给最大值
                if (data.Data.length && data.Data.length != 0) {
                    for (var i = 0; i < data.Data.length; i++) {
                        if (data.Data[i].id > parseInt(maxId)) {
                            maxId = data.Data[i].id;
                        }
                        datatable.datagrid('insertRow', {
                            index: 0,
                            row: data.Data[i]
                        });
                        index++;
                    }
                }
                if (index > 49) {
                    for (var i = index; i > 49; i--) {
                        datatable.datagrid('deleteRow', i);
                        index--;
                    }
                }
            });
        };
       
    </script>
</head>
<script>
    var LocalID = $.cookie("LocalID");
    var sortName = "id";
    var sortOrder = "asc";
    var PageSize = 10;
    var PageNum = 1;
    var jsondata = { "total": 0, "rows": [] };
    var datatable;
    var rool;
    var maxId = -1;
    var id = -1;
    //计算table最大索引
    var index = -1;
</script>
<body>
    <table id='tbInfo' class='easyui-datagrid' data-options="rownumbers:true,singleSelect:true,fitColumns:true,striped:true,pagination:false, collapsible: false,iconCls:'icon-search', pageList: [10, 20, 50, 100],fit:true,"
        title="实时记录">
        <thead>
            <tr>
                <th style='width: 100px;' data-options="field:'flag',sortable:false,align:'center',formatter:getFlagTK">
                    状态
                </th>
                <th style='width: 100px;' data-options="field:'user_name',align:'center',sortable:false">
                    姓名
                </th>
                <th style='width: 100px;' data-options="field:'elevator_name',align:'center',sortable:false">
                    电梯
                </th>
                <th style='width: 100px;' data-options="field:'room_name',align:'center',sortable:false">
                    出发楼层
                </th>
                <th style='width: 100px;' data-options="field:'from_floor',align:'center',sortable:false">
                    到达楼层
                </th>
                <th style='width: 100px;' data-options="field:'case_time',sortable:false,align:'center',formatter:getTimeTK">
                    时间
                </th>
                <th style='width: 100px;' data-options="field:'net_flag',sortable:false,align:'center',formatter:getNetFlagTK">
                    网络
                </th>
            </tr>
        </thead>
    </table>
    <script>
        $(function () {
            iniGrid();
            getMaxId();
            setInterval(loaddata, 10000);
        })
       
    </script>
</body>
</html>
