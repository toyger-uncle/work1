<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <link href="../../Scripts/jquery-easyui/themes/IconExtension.css" rel="stylesheet"
        type="text/css" />
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/constant.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>
    <style type="text/css">
        body
        {
            font-family: verdana,helvetica,arial,sans-serif,宋体;
            font-size: 12px;
            margin: 0;
            padding: 2px;
        }
        h2
        {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 15px;
        }
        .demo-info
        {
            padding: 0 0 12px;
        }
        .demo-tip
        {
            display: none;
        }
        .textbox
        {
            height: 20px;
            margin: 0;
            padding: 0 2px;
            box-sizing: content-box;
        }
    </style>
    <script type="text/javascript">
        var LocalID = $.cookie("LocalID");
        var datagrid;
        var jsondata = { "total": 0, "rows": [] };
        var datagrid2;
        var jsondata2 = { "total": 0, "rows": [] };
        var aa;
        var bb;
        $(function () {
            Ajax(true, global.kq["GetKQWindowGrpList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#belong_group').combobox({
                    data: data.Data,
                    valueField: 'id',
                    textField: 'group_name'
                });
            });
            $('#modem').combobox({
                onSelect: function () {
                    var value = $("#modem").combobox('getValue')
                    if (value == 1) {
                        $("#com_name").combobox({ disabled: false });
                        $("#ip").attr("disabled", true);
                        $("#port").attr("disabled", true);
                    }
                    if (value == 2) {
                        $("#com_name").combobox({ disabled: true });
                        $("#ip").attr("disabled", false);
                        $("#port").attr("disabled", false);
                    }
                    if (value == 4) {
                        $("#com_name").combobox({ disabled: true });
                        $("#ip").attr("disabled", true);
                        $("#port").attr("disabled", true);
                    }
                }
            });
            datagrid = $("#dg").datagrid({
                idField: "id",
                fitColumns: true,
                striped: true,
                title: "",
                rownumbers: true,
                singleSelect: true,
                columns: [[{
                    field: 'group_name',
                    title: '班组名',
                    //                sortable: true,
                    width: "95%"
                }]],
                toolbar: [{
                    text: "删除", iconCls: "icon-remove", handler: function () {
                        var rowData = datagrid.datagrid('getSelections');
                        var ids;
                        if (rowData == null || rowData.length == 0) {
                            $.messager.alert("提示", "未选择项", "error");
                            return;
                        }
                        $.messager.confirm("提示", "确定要删除所选项？", function (data) {
                            if (data) {
                                for (var i = 0; i < rowData.length; i++) {
                                    ids = rowData[i].id;
                                    Ajax(true, global.kq["RemoveKQWindowGrp"], { LoginID: LocalID, id: ids }, function (data) {
                                        if (!data.Success) {
                                            alert(data.Message);
                                            return;
                                        }
                                        loaddata();
                                    });
                                }
                                $.messager.alert("提示", "删除成功", "info");
                            }
                        });
                    }
                }, {
                    text: "修改", iconCls: "icon-edit", handler: function () {
                        var rows = datagrid.datagrid('getSelected');
                        if (rows == null) {
                            $.messager.alert("提示", "未选择项", "error");
                            return;
                        }
                        $('#win').window('open');
                        $('#group_name').val(rows.group_name);
                        aa = 1;

                    }
                }, {
                    text: "增加", iconCls: "icon-add", handler: function () {
                        $('#win').window('open');
                        $('#group_name').val("");
                        aa = 0;

                    }
                }],
                onDblClickRow: function (rowIndex, rowData) {
                    $('#win').window('open');
                    $('#group_name').val(rowData.group_name);
                    aa = 1;
                }
            });
            datagrid2 = $("#dg2").datagrid({
                idField: "id",
                fitColumns: true,
                striped: true,
                title: "",
                rownumbers: true,
                singleSelect: true,
                columns: [[{
                    field: 'window_num',
                    title: '窗口号',
                    //                sortable: true,
                    width: "13%"
                }, {
                    field: 'mach_type',
                    title: '类型',
                    //                sortable: true,
                    width: "13%",
                    formatter: function (value, row) {
                        if (value == "01") {
                            return '进出不分';
                        }
                        if (value == "00") {
                            return '进';
                        }
                        if (value == "15") {
                            return '出';
                        }

                    }
                }, {
                    field: 'group_name',
                    title: '属于班组',
                    //                sortable: true,
                    width: "13%"
                }, {
                    field: 'modem',
                    title: '通讯方式',
                    //                sortable: true,
                    width: "13%",
                    formatter: function (value, row) {
                        if (value == "1") {
                            return '串口';
                        }
                        if (value == "2") {
                            return '以太网';
                        }
                        if (value == "4") {
                            return '以太网主动上传';
                        }
                        if (value == "3") {
                            return '万博以太网';
                        }

                    }
                }, {
                    field: 'com_name',
                    title: '串口号',
                    //                sortable: true,
                    width: "13%",
                    formatter: function (value, row) {
                        if (value == "1") {
                            return 'COM1';
                        }
                        if (value == "2") {
                            return 'COM2';
                        }
                        if (value == "3") {
                            return 'COM3';
                        }
                        if (value == "4") {
                            return 'COM4';
                        }
                        if (value == "5") {
                            return 'COM5';
                        }
                        if (value == "6") {
                            return 'COM6';
                        }
                        if (value == "7") {
                            return 'COM7';
                        }
                        if (value == "8") {
                            return 'COM8';
                        }
                    }
                }, {
                    field: 'ip',
                    title: 'IP地址',
                    //                sortable: true,
                    width: "13%"
                }, {
                    field: 'port',
                    title: '端口',
                    //                sortable: true,
                    width: "10%"
                }]],
                toolbar: [{
                    text: "删除", iconCls: "icon-remove", handler: function () {
                        var rowData = datagrid2.datagrid('getSelections');
                        var ids;
                        if (rowData == null || rowData.length == 0) {
                            $.messager.alert("提示", "未选择项", "error");
                            return;
                        }
                        $.messager.confirm("提示", "确定要删除所选项？", function (data) {
                            if (data) {
                                for (var i = 0; i < rowData.length; i++) {
                                    ids = rowData[i].id;
                                    Ajax(true, global.kq["RemoveKQWindow"], { LoginID: LocalID, id: ids }, function (data) {
                                        if (!data.Success) {
                                            alert(data.Message);
                                            return;
                                        }
                                        loaddata2();
                                    });
                                }
                                $.messager.alert("提示", "删除成功", "info");
                            }
                        });
                    }
                }, {
                    text: "修改", iconCls: "icon-edit", handler: function () {
                        var rows = datagrid2.datagrid('getSelected');
                        if (rows == null) {
                            $.messager.alert("提示", "未选择项", "error");
                            return;
                        }
                        $('#win2').window('open');
                        $('#window_num').val(rows.window_num);
                        $("#mach_type").combobox("setValue", rows.mach_type);
                        $("#belong_group").combobox("setValue", rows.belong_group);
                        $("#modem").combobox("setValue", rows.modem);
                        $("#com_name").combobox("setValue", rows.com_name);
                        $('#ip').val(rows.ip);
                        $('#port').val(rows.port);
                        bb = 1;

                    }
                }, {
                    text: "增加", iconCls: "icon-add", handler: function () {
                        $('#win2').window('open');
                        Ajax(true, global.kq["GetKQWindowNUM"], { LoginID: LocalID }, function (data) {
                            if (!data.Success) {
                                alert(data.Message);
                                return;
                            }
                            $('#window_num').val(data.Data);
                        });
                        $("#mach_type").combobox("setValue");
                        $("#belong_group").combobox("setValue");
                        $("#modem").combobox("setValue");
                        $("#com_name").combobox("setValue");
                        $('#ip').val("");
                        $('#port').val("");
                        bb = 0;

                    }
                }],
                onDblClickRow: function (rowIndex, rowData) {
                    $('#win2').window('open');
                    $('#window_num').val(rowData.window_num);
                    $("#mach_type").combobox("setValue", rowData.mach_type);
                    $("#belong_group").combobox("setValue", rowData.belong_group);
                    $("#modem").combobox("setValue", rowData.modem);
                    $("#com_name").combobox("setValue", rowData.com_name);
                    $('#ip').val(rowData.ip);
                    $('#port').val(rowData.port);
                    bb = 1;
                }
            });
            loaddata();
            loaddata2();
            $('#win').window('close');
            $('#win2').window('close');
            $("#close").click(function () {
                $('#win').window('close');
            });
            $("#close2").click(function () {
                $('#win2').window('close');
            });
            $("#save").click(function () {

                var row = datagrid.datagrid('getSelected');
                var group_name = $("#group_name").val();
                if (aa == 0) {
                    if (group_name == "") {
                        alert("班组名不能为空!");
                        return;
                    }
                    Ajax(true, global.kq["NewKQWindowGrp"], { LoginID: LocalID, group_name: group_name }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        $.messager.alert("提示", "添加成功", "info");
                        $('#win').window('close');
                        loaddata();
                    });
                }
                if (aa == 1) {
                    if (group_name == "") {
                        alert("班组名不能为空!");
                        return;
                    }
                    var id = row.id;
                    Ajax(true, global.kq["UpdateKQWindowGrp"], { LoginID: LocalID, id: id, group_name: group_name }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        $.messager.alert("提示", "修改成功", "info");
                        $('#win').window('close');
                        loaddata();
                    });
                }
            });


            $("#save2").click(function () {

                var row = datagrid2.datagrid('getSelected');
                var window_num = $('#window_num').val();
                var mach_type = $("#mach_type").combobox("getValue");
                var belong_group = $("#belong_group").combobox("getValue");
                var modem = $("#modem").combobox("getValue");
                var com_name = $("#com_name").combobox("getValue");
                var ip = $('#ip').val();
                var port = $('#port').val();
                if (window_num == "") {
                    alert("窗口号不能为空!");
                    return;
                }
                if (mach_type == "") {
                    alert("机器类型不能为空!");
                    return;
                }
                if (belong_group == "") {
                    alert("班组不能为空!");
                    return;
                }

                if (modem == "") {
                    alert("通讯方式不能为空!");
                    return;
                }
                if (modem == 2) {
                    var re = /^(\d+)\.(\d+)\.(\d+)\.(\d+)$/; //正则表达式
                    if (re.test(ip)) {
                        if (RegExp.$1 < 256 && RegExp.$2 < 256 && RegExp.$3 < 256 && RegExp.$4 < 256) {
                            if (bb == 0) {
                                Ajax(true, global.kq["NewKQWindow"], { LoginID: LocalID, window_num: window_num, mach_type: mach_type, belong_group: belong_group, modem: modem, com_name: com_name, ip: ip, port: port }, function (data) {
                                    if (!data.Success) {
                                        alert(data.Message);
                                        return;
                                    }
                                    $.messager.alert("提示", "添加成功", "info");
                                    $('#win2').window('close');
                                    loaddata2();
                                });
                            }
                            if (bb == 1) {
                                var id = row.id;
                                Ajax(true, global.kq["UpdateKQWindow"], { LoginID: LocalID, id: id, window_num: window_num, mach_type: mach_type, belong_group: belong_group, modem: modem, com_name: com_name, ip: ip, port: port }, function (data) {
                                    if (!data.Success) {
                                        alert(data.Message);
                                        return;
                                    }
                                    $.messager.alert("提示", "修改成功", "info");
                                    $('#win2').window('close');
                                    loaddata2();
                                });
                            }
                        }
                    }
                    else {
                        alert("IP有误！");
                        return;
                    }
                }
                if (bb == 0) {
                    Ajax(true, global.kq["NewKQWindow"], { LoginID: LocalID, window_num: window_num, mach_type: mach_type, belong_group: belong_group, modem: modem, com_name: com_name, ip: ip, port: port }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        $.messager.alert("提示", "添加成功", "info");
                        $('#win2').window('close');
                        loaddata2();
                    });
                }
                if (bb == 1) {
                    var id = row.id;
                    Ajax(true, global.kq["UpdateKQWindow"], { LoginID: LocalID, id: id, window_num: window_num, mach_type: mach_type, belong_group: belong_group, modem: modem, com_name: com_name, ip: ip, port: port }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        $.messager.alert("提示", "修改成功", "info");
                        $('#win2').window('close');
                        loaddata2();
                    });
                }
            });
        });

        function loaddata() {
            datagrid.datagrid('unselectAll');
            Ajax(true, global.kq["GetKQWindowGrpList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jsondata.rows = data.Data;
                datagrid.datagrid('loadData', jsondata);
            });
        }
        function loaddata2() {
            datagrid2.datagrid('unselectAll');
            Ajax(true, global.kq["GetKQWindowList"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jsondata2.rows = data.Data;
                datagrid2.datagrid('loadData', jsondata2);
            });
        }
    </script>
</head>
<body>
    <div class="easyui-layout" data-options="fit:true">
        <div class="easyui-tabs" data-options="collapsible:false,maximized:true" style="width: 100%;">
            <div title="考勤班组" data-options="href :''" style="">
                <div style="width: 100%; height: 400px;">
                    <table id="dg">
                    </table>
                </div>
                <div id="win" class="easyui-window" title="考勤班组" data-options="iconCls:'icon-save',minimizable:false,maximizable:false"
                    style="width: 300px; height: 150px; padding: 5px;">
                    <div class="easyui-layout" data-options="fit:true">
                        <div data-options="region:'center'" style="padding: 5px;">
                            <table cellpadding="5">
                                <tr>
                                    <td>
                                        班组名：
                                    </td>
                                    <td>
                                        <input id="group_name" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                            height: 20px" />
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                            <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)"
                                id="close" style="width: 80px">关闭</a> <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'"
                                    href="javascript:void(0)" id="save" style="width: 80px">提交</a>
                        </div>
                    </div>
                </div>
            </div>
            <div title="考勤机" data-options="href :''" style="">
                <div style="width: 100%; height: 400px;">
                    <table id="dg2">
                    </table>
                </div>
                <div id="win2" class="easyui-window" title="考勤机号" data-options="iconCls:'icon-save',minimizable:false,maximizable:false"
                    style="width: 300px; height: 400px; padding: 5px;">
                    <div class="easyui-layout" data-options="fit:true">
                        <div data-options="region:'center'" style="padding: 5px;">
                            <table cellpadding="5">
                                <tr>
                                    <td>
                                        窗口号：
                                    </td>
                                    <td>
                                        <input id="window_num" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                            height: 20px" disabled="disabled" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        类型：
                                    </td>
                                    <td>
                                        <select id="mach_type" class="easyui-combobox" style="width: 130px; height: 20px">
                                            <option value="01">不分进出</option>
                                            <option value="00">进</option>
                                            <option value="15">出</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        属于班组：
                                    </td>
                                    <td>
                                        <select id="belong_group" class="easyui-combobox" style="width: 130px; height: 20px">
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        通讯方式：
                                    </td>
                                    <td>
                                        <select id="modem" class="easyui-combobox" style="width: 130px; height: 20px">
                                            <option value="1">串口</option>
                                            <option value="2">以太网被动</option>
                                            <option value="4">以太网主动</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        串口号：
                                    </td>
                                    <td>
                                        <select id="com_name" class="easyui-combobox" style="width: 130px; height: 20px">
                                            <option value="1">COM1</option>
                                            <option value="2">COM2</option>
                                            <option value="3">COM3</option>
                                            <option value="4">COM4</option>
                                            <option value="5">COM5</option>
                                            <option value="6">COM6</option>
                                            <option value="7">COM7</option>
                                            <option value="8">COM8</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        IP地址：
                                    </td>
                                    <td>
                                        <input id="ip" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                            height: 20px" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        端口：
                                    </td>
                                    <td>
                                        <input id="port" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                            height: 20px" />
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                            <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)"
                                id="close2" style="width: 80px">关闭</a> <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'"
                                    href="javascript:void(0)" id="save2" style="width: 80px">提交</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
