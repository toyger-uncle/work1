<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>	
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css"/>
	<link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <script src="../../Scripts/constant.js" type="text/javascript"></script>
    <script src="../../Scripts/scene_lang_ch.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>	
       <style type="text/css" >
body {
font-family: verdana,helvetica,arial,sans-serif,宋体;
font-size: 12px;
margin: 0;
padding: 2px;
}
</style>
<script type="text/javascript">
    var LocalID = $.cookie("LocalID");
    var datagrid;
    var datagrid1;
    var a;
    var jsondata = { "total": 0, "rows": [] };
    var jsondata1 = { "total": 0, "rows": [] };
    var allUserKind;
    var sortName = "user_name";
    var sortOrder = "asc";
    var PageSize = 10;
    var PageNum = 1;
    $(function () {
        Ajax(true, global.rl["GetRlMachRlList"], { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            $('#kind').combobox({
                data: data.Data,
                valueField: 'id',
                textField: 'id'
            });
        });
        Ajax(true, global.sys.GetDepartList, { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                // $('#text').select();
                return;
            };
            var temp = { 'id': '', 'department': '全部' };
            data.Data.push(temp);
            allDepart = data.Data;

            $('#depart_id1').combobox({
                data: allDepart,
                valueField: 'id',
                textField: 'department'
            });
        });
        Ajax(false, global.sys["GetUserKindList"], { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            var temp = { 'id': '', 'user_kind': '全部' };
            data.Data.push(temp);
            allUserKind = data.Data;
            $('#user_kind1').combobox({
                data: allUserKind,
                valueField: 'id',
                textField: 'user_kind'
            });
        });
        datagrid = $("#dg").datagrid({
            idField: "user_name",
            fitColumns: true,
            striped: true,
            title: "",
            collapsible: true,
            remotesort: false,
            rownumbers: true,
            sortName: sortName,
            sortOrder: sortOrder,
            singleSelect: true,
            columns: [[{

                field: 'user_name',
                title: '用户名',
                width: 80,
                sortable: true
            }, {
                field: 'password',
                title: '密码',
                width: 80,
                sortable: true
            }, {
                field: 'card_id',
                title: '卡号',
                width: 80,
                sortable: true
            }, {
                field: 'rl_id',
                title: '人脸号',
                width: 80,
                sortable: true
            }, {
                field: 'xh',
                title: '序号',
                width: 80,
                sortable: true
            }, {
                field: 'mach_id',
                title: '人脸来源',
                width: 80,
                sortable: true
            }, {
                field: 'in_date',
                title: '获得时间',
                width: 80,
                sortable: true
            }
            ]],
            //排列行
            onSortColumn: function (sort, order) {
                sortName = sort;
                sortOrder = order;
                loaddata($("#text").val());
            }
        });
        datagrid1 = $("#dg1").datagrid({
            idField: "user_name",
            fitColumns: true,
            striped: true,
            title: "",
            collapsible: true,
            remotesort: false,
            rownumbers: true,
            singleSelect: true,
            sortName: sortName,
            sortOrder: sortOrder,
            columns: [[{
                field: 'user_name',
                title: '用户',
                width: 80,
                height: 20,
                sortable: true
            }, {
                field: 'depart_name',
                title: '部门',
                width: 80,
                height: 20,
                sortable: true
            }, {
                field: 'user_kind',
                title: '用户类型',
                width: 80,
                height: 20,
                sortable: true,
                formatter: function (value, row, index) {
                    if (allUserKind != null) {
                        for (var i = 0; i < allUserKind.length; i++) {
                            if (allUserKind[i]['id'] == row.user_kind)
                                return allUserKind[i]['user_kind'];
                        }
                        return row.user_kind;
                    }
                }
            }, {
                field: 'userid_num',
                title: '证件号',
                width: 80,
                height: 20,
                sortable: true

            }]],
            onSelect: function (rowIndex, rowData) {

            },
            //排列行
            onSortColumn: function (sort, order) {
                sortName = sort;
                sortOrder = order;
                loaddata1($("#text").val());
            }

        });
        loaddata();
        loaddata1();
        $('#win').window('close');
        $("#search1").click(function () {
            loaddata1($("#user_name1").val(), $("#userid_num1").val(), $("#depart_id1").combobox("getValue"), $("#user_kind1").combobox("getValue"));
        });
        var DO = $("#DO").find("input:checkbox");
        DO.prop("checked", true);
        $("#search").click(function () {
            loaddata($("#text").val(), $("#kind").combobox("getValue"));
        });
        $("#update").click(function () {
            var rows = datagrid.datagrid('getSelected');
            if (rows == null) {
                $.messager.alert("提示", "未选择项", "error");
                return;
            }
            $('#win').window('open');
            $('#user_name').val(rows.user_name);
            $('#password').val(rows.password);
            $('#card_id').val(rows.card_id);
        });
        $("#save").click(function () {
            var row = datagrid.datagrid('getSelected');
            var id = row.rl_id;
            var user_name = $('#user_name').val();
            var password = $('#password').val();
            var card_id = $('#card_id').val();
            Ajax(true, global.rl["UpdateRlMachUser"], { LoginID: LocalID, rl_id: id, user_name: user_name, password: password, card_id: card_id }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $.messager.alert("提示", "修改成功", "info");
                loaddata();
                $('#win').window('close');
            });
        });
        $("#qingkong").click(function () {
            Ajax(true, global.rl["RemoveAllRlMachRl"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $.messager.alert("提示", "清空成功", "info");
                loaddata();
            });
        });
        $("#all").click(function () {
            var userflag;
            if ($("#do1").prop("checked") == true) { userflag = 1; }
            else { userflag = ""; }
            var cardflag;
            if ($("#do2").prop("checked") == true) { cardflag = 1; }
            else { cardflag = ""; }
            var zwflag;
            if ($("#do3").prop("checked") == true) { rlflag = 1; }
            else { rlflag = ""; }

            $.messager.confirm("提示", "超过5000条只能下载前5000条记录，请分批操作", function (data) {
                if (data) {
                    Ajax(true, global.rl["RlMachRlToRlInfoAll"], { LoginID: LocalID, userflag: userflag, cardflag: cardflag, rlflag: rlflag }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        $.messager.alert("提示", "导入成功", "info");
                        loaddata();
                    });
                }
            });
        });
        $("#remove").click(function () {
            var rowData = datagrid.datagrid('getSelections');
            var ids = "";
            var xh = "";
            for (var i = 0; i < rowData.length; i++) {
                if (i != 0) {
                    ids += "|";
                    xh += "|";
                }
                ids += rowData[i].rl_id;
                xh += rowData[i].xh;
            }
            if (rowData == null || rowData.length == 0) {
                $.messager.alert("提示", "未选择项", "error");
                return;
            }
            Ajax(true, global.rl["RemoveRlMachRl"], { LoginID: LocalID, rl_id: ids, xh: xh }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $.messager.alert("提示", "删除成功", "info");
                loaddata();
            });
        });
        $("#one").click(function () {
            var rowData = datagrid.datagrid('getSelected');

            var row = datagrid1.datagrid('getSelected');
            if (rowData == null) {
                $.messager.alert("提示", "未选择项", "error");
                return;
            }
            var ids = rowData.rl_id;
            var xh = rowData.xh;
            var user = row.id;
            var userflag;
            if ($("#do1").prop("checked") == true) { userflag = 1; }
            else { userflag = ""; }
            var cardflag;
            if ($("#do2").prop("checked") == true) { cardflag = 1; }
            else { cardflag = ""; }
            var zwflag;
            if ($("#do3").prop("checked") == true) { rlflag = 1; }
            else { rlflag = ""; }
            Ajax(true, global.rl["RlMachRlToRlInfo"], { LoginID: LocalID, user_id: user, rl_id: ids, xh: xh, userflag: userflag, cardflag: cardflag, rlflag: rlflag }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $.messager.alert("提示", "导入成功", "info");
                loaddata();
            });
        });
    });
    function loaddata(user_name, rl_id) {
        datagrid.datagrid('unselectAll');
        Ajax(true, global.rl["GetRlMachRlPageList"], { LoginID: LocalID, user_name: user_name, mach_id: rl_id, sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata.total = data.Ex;
            jsondata.rows = data.Data;
            datagrid.datagrid('loadData', jsondata);
            if (jsondata.total == 0) {
                PageNum = 1;
            }
            var p = datagrid.datagrid('getPager');
            $(p).pagination({
                beforePageText: '第', //页数文本框前显示的汉字 
                afterPageText: '页    共 ' + Math.ceil(jsondata.total / PageSize) + ' 页',
                displayMsg: '当前显示 ' + (PageSize * (PageNum - 1) + (jsondata.total == 0 ? 0 : 1)) + ' - ' + (PageSize * (PageNum - 1) + data.Data.length) + ' 条记录   共 ' + jsondata.total + ' 条记录',
                onSelectPage: function (pageNumber, pageSize) {
                    PageSize = pageSize;
                    PageNum = pageNumber;
                    if (PageNum < 1) {
                        PageNum = 1;
                    }
                    loaddata(user_name, rl_id);
                }
            });

        });
    }
    function loaddata1(user_name, userid_num, depart_id, user_kind) {
        datagrid1.datagrid('unselectAll');
        Ajax(true, global.sys["GetUserFilePageListOfTK"], { LoginID: LocalID, user_name: user_name, depart_id: depart_id, userid_num: userid_num, user_kind: user_kind, sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata1.total = data.Ex;
            jsondata1.rows = data.Data;
            datagrid1.datagrid('loadData', jsondata1);
            if (jsondata.total == 0) {
                PageNum = 1;
            }
            var p = datagrid1.datagrid('getPager');
            $(p).pagination({
                beforePageText: '第', //页数文本框前显示的汉字 
                afterPageText: '页    共 ' + Math.ceil(jsondata1.total / PageSize) + ' 页',
                displayMsg: '当前显示 ' + (PageSize * (PageNum - 1) + (jsondata1.total == 0 ? 0 : 1)) + ' - ' + (PageSize * (PageNum - 1) + data.Data.length) + ' 条记录   共 ' + jsondata1.total + ' 条记录',
                onSelectPage: function (pageNumber, pageSize) {
                    PageSize = pageSize;
                    PageNum = pageNumber;
                    if (PageNum < 1) {
                        PageNum = 1;
                    }

                    loaddata(user_name, userid_num, depart_id, user_kind);
                }
            });
        });
    }
</script>
</head>
<body>
<div class="easyui-panel" title="人脸绑定" data-options="collapsible:false,maximized:true" style="width:100%; padding:2px; ">
<div class="easyui-layout" data-options="fit:true"style="">
<div style="width:100%; height:550px;">
<div>   
人脸来源：<select id="kind" class="easyui-combobox"  style="width:80px;height:20px"> </select>
用户名：<input id="text" class="easyui-validatebox textbox"style="width:80px;height:20px" data-options="" />
<a href="javascript:void(0)" class="easyui-linkbutton" id="search" data-options="iconCls:'icon-search'">查询</a>
<a class="easyui-linkbutton" data-options="iconCls:'icon-edit'" href="javascript:void(0)" id="update" >修改</a>
<a class="easyui-linkbutton" data-options="iconCls:'icon-remove'" href="javascript:void(0)" id="remove" >删除</a>
<a class="easyui-linkbutton" data-options="iconCls:'icon-remove'" href="javascript:void(0)" id="qingkong" >清空</a>
</div>
<div id="DO" style="padding: 5px;">
<input type="checkbox" id="do1" value="1"   />用户
<input type="checkbox" id="do2" value="2"  />卡
<input type="checkbox" id="do3" value="3" />人脸
<a class="easyui-linkbutton" data-options="" href="javascript:void(0)" id="one" >单条导入</a>
<a class="easyui-linkbutton" data-options="" href="javascript:void(0)" id="all" >全部导入</a>
</div>
	<table id="dg"style="padding: 5px;"data-options="pagination:true"> </table>  
    <div id='barUser' style='padding: 5px;'>
            <div style='margin-bottom: 5px'>
                姓名:<input id='user_name1' class='easyui-validatebox textbox' style='width: 100px' />
                工号:<input id='userid_num1' class='easyui-validatebox textbox' style='width: 100px' />
                选择部门:<input id='depart_id1' class='easyui-combobox' style='width: 100px' />
                用户类型:<input id='user_kind1' class='easyui-combobox' style='width: 100px' />
                &nbsp; <a href="javascript:void(0)" class="easyui-linkbutton" id="search1" data-options="iconCls:'icon-search'"> 查询用户 </a>
            </div>
        </div>
         <table id="dg1"data-options="pagination:true" title="用户信息" toolbar='#barUser'></table>
</div>
     </div>
     </div>
     <div id="win" class="easyui-window" title="修改" data-options="iconCls:'icon-save',minimizable:false,maximizable:false" style="width:250px;height:200px;padding:5px;">
	<div class="easyui-layout" data-options="fit:true">
    <div data-options="region:'center'" style="padding:5px;">
			  <table cellpadding="5">
			<tr>
				<td>用户名：</td>
				<td><input id="user_name" class="easyui-validatebox textbox" data-options=""  style="width:120px;height:20px"/></td>	
                </tr>
			<tr>
                <td>密码：</td>
				<td><input id="password" class="easyui-validatebox textbox" data-options=""  style="width:120px;height:20px"/> </td>
			</tr>
			<tr>
				<td>卡号：</td>
				<td><input id="card_id" class="easyui-validatebox textbox" data-options=""  style="width:120px;height:20px" maxlength="8"/> </td>
            </tr>
            
		</table>
		</div>
		<div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
			
            <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" id="close" style="width:80px">关闭</a>
			<a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" id="save" style="width:80px">提交</a>
		</div>
	</div>
</div>
</body>
</html>
