<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>	
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css"/>
	<link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <link href="../../Scripts/jquery-easyui/themes/IconExtension.css" rel="stylesheet"
        type="text/css" />
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>	
<style type="text/css" >
body {
font-family: verdana,helvetica,arial,sans-serif,宋体;
font-size: 12px;
margin: 0;
padding: 20px;
}
h2 {
font-size: 18px;
font-weight: bold;
margin: 0 0 15px;
}
.demo-info {
padding: 0 0 12px;
}
.demo-tip {
display: none;
}
.textbox{
height:20px;
margin:0;
padding:0 2px;
box-sizing:content-box;
}
</style>

<script type="text/javascript">
    var LocalID = $.cookie("LocalID");
    var tree;
    var cardsnr = "";
    var TKPlaintext = "";
    var SysOriginalCiphertext = "";
    var SysCiphertext;
    var rooltime = 1000;
    var cot = 0;
    var maxcot = 12000;
    var datagrid;
    var jsondata = { "total": 0, "rows": [] };
    var Ljsondata = { "total": 0, "rows": [] };
    var sortName = "id";
    var sortOrder = "asc";
    var PageSize = 10;
    var PageNum = 1;
    var rool;
    var num = "";
    $(function () {
        while (true) {
            var ActiveX;
            var ret;
            try {
                ActiveX = $("#ActiveX")[0];
                ret = ActiveX.GetVersion();
            }
            catch (e) {
                $("#info").css("color", "Red");
                $("#info").html("初始化失败，请安装做卡插件，重试！");
                return;
                continue;
            }
            if (ret != "1.0") {
                $("#info").css("color", "Red");
                $("#info").html("做卡插件版本不匹配，请重新安装对应版本，重试！" + "(当前" + ret + "软件需要1.0)");
                return;
                continue;
            }
            ret = ActiveX.OpenCom();
            if (ret != 0) {
                $("#info").css("color", "Red");
                $("#info").html("初始化失败，请插好读卡器，重试！");
                return;
                continue;
            }
            break;
        }

        var curr_time1 = new Date();
        var strDate1 = curr_time1.getFullYear() + 3 + "-";
        strDate1 += curr_time1.getMonth() + 1 + "-";
        strDate1 += curr_time1.getDate();
        var curr_time = new Date();
        var strDate = curr_time.getFullYear() + "-";
        strDate += curr_time.getMonth() + 1 + "-";
        strDate += curr_time.getDate();
        $('#bt').datebox('setValue', strDate);
        $('#et').datebox('setValue', strDate1);
        tree = $("#tree").tree({
            checkbox: true,
            onCheck: function (node) {
                if (node.attributes.kind == "A") {
                    num = parseInt(num) + parseInt(node.children.length);
                }
                if (node.attributes.kind == "D") {
                    if (num == "") {
                        num = num + 1;
                    }
                    else {
                        num = parseInt(num) + 1;
                    }
                }
            }
        });
        $('#mima').combobox({
            onChange: function (newValue, oldValue) {
                if (newValue == "1") {
                    $('#mi1').hide();
                }
                if (newValue == "2") {
                    $('#mi1').show();
                    $('#miyao').val("");
                }
            }
        });
        $('#mi1').hide();
        datagrid = $("#dg").datagrid({
            idField: "id",
            pagination: true, //显示分页  
            pageSize: PageSize, //分页大小  
            pageList: [10, 20, 50, 100], //每页的个数  
            //fit: true, //自动补全  
            fitColumns: true,
            striped: true,
            iconCls: "icon-search", //图标  
            title: "选择用户",
            collapsible: true,
            remotesort: false,
            singleSelect: true,
            //rownumbers:true,
            sortName: sortName,
            sortOrder: sortOrder,
            columns: [[{
                field: 'id',
                title: '编号',
                sortable: true,
                width: 50
            }, {
                field: 'user_name',
                title: '用户',
                sortable: true,
                width: 50
            }, {
                field: 'depart_name',
                title: '部门',
                sortable: true,
                width: 80
            }, {
                field: 'kind_name',
                title: '类型',
                sortable: true,
                width: 50
            }, {
                field: 'userid_num',
                title: '工号',
                sortable: true,
                width: 50
            }, {
                field: 'role_name',
                title: '角色',
                sortable: true,
                width: 80
            }, {
                field: 'room_name',
                title: '房间',
                sortable: true,
                width: 80
            }]],
            onSelect: function (rowIndex, rowData) {
                if (rowData == null) {
                    $.messager.alert("提示", "未选择项", "error");
                    return;
                }
                $("#depart").val(rowData.depart_name);
                $("#text").val(rowData.user_name);
                var newValue = $('#select').combobox("getValue");
                if (newValue == "03" || newValue == "08" || newValue == "12") {
                    Ajax(true, global.tk["GetTkUserRight"], { LoginID: LocalID, user_file: rowData.id }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                    });
                }
            },
            onSortColumn: function (sort, order) {
                sortName = sort;
                sortOrder = order;
                loaddata($("#departname").val(), $("#kindname").val(), $("#roomname").val(), $("#username").val(), $("#useridnum").val());
            }
        });
        $("#info").html("获取出厂密钥……");
        Ajax(true, global.sys["GetSysOriginalCiphertext"], { LoginID: LocalID }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            SysOriginalCiphertext = data.Data;
            $("#info").html("获取出厂密钥成功");
            $("#info").html("获取消费密钥……");
            Ajax(true, global.sys["GetSysCiphertext"], { LoginID: LocalID }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                TKPlaintext = data.Data;
                $("#info").html("获取消费密钥成功");
                readcard();
            });
        });
        loaddata($("#departname").val(), $("#kindname").val(), $("#roomname").val(), $("#username").val(), $("#useridnum").val());
        $("#search").click(function () {
            loaddata($("#departname").val(), $("#kindname").val(), $("#roomname").val(), $("#username").val(), $("#useridnum").val());
        });
        $("#make").click(function () {
            clearTimeout(rool);
            var bl = true;
            var newValue = $('#select').combobox("getValue");
            var datax = "{\"card_snr\":\"" + cardsnr + "\",\"card_key\":\"FFFFFFFFFFFF\"}";
            var data = "{\"card_snr\":\"" + cardsnr + "\",\"card_key\":\"" + SysOriginalCiphertext + "\"}";
            var keys = "{\"Key\":7,\"Value\":\"" + SysOriginalCiphertext + "\"}";
            keys = "[" + keys + "]";
            var ret = ActiveX.RFMifare_AllInitCard(data, keys, "");
            data = JSON2.parse(ret);
            if (!data.Success) {
                ret = ActiveX.RFMifare_AllInitCard(datax, keys, "");
                if (newValue == "14") {
                    bl = make14();
                }
                if (bl) {
                    rool = setTimeout(function () { readcard() }, rooltime);
                }
            }
            else {
                if (newValue == "14") {
                    bl = make14();
                }
                if (bl) {
                    rool = setTimeout(function () { readcard() }, rooltime);
                } 
            }
        });
        $("#recy").click(function () {
            if (cardsnr == "") {
                $.messager.alert("提示", "请放好卡", "error", function () { });
                return;
            }
            clearTimeout(rool);
            var psw;
            if ($("#mima").combobox("getValue") == "1") {
                psw = SysOriginalCiphertext;
                var cardinfo = "{\"card_snr\":\"" + cardsnr + "\",\"card_key\":\"" + psw
                    + "\",\"blockdatas\":[{\"Key\":29,\"Value\":\"00000000000000000000000000000000\"},{\"Key\":4,\"Value\":\"00000000000000000000000000000000\"}]}";
                cardinfo = ActiveX.RFMifare_AllWriteCard(cardinfo);
                var cardinfojson = JSON2.parse(cardinfo);
                if (!cardinfojson.Success) {
                    $("#info").css("color", "Red");
                    $("#info").html("退卡失败，卡号：" + cardsnr + "，原因：错误信息：" + cardinfojson.Message);
                    rool = setTimeout(function () { readcard() }, rooltime);
                    return;
                }
                else {
                    Ajax(true, global.ms["RecycleCardUsing"], { LoginID: LocalID, card_id: cardid }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        $("#info").css("color", "Green");
                        $("#info").html("退卡成功，卡号：" + cardsnr);
                        ActiveX.RFMifare_Alarm(4, 10, 0, 1);
                        rool = setTimeout(function () { readcard() }, rooltime);
                    });

                }
            }
            if ($("#mima").combobox("getValue") == "2") {
                Ajax(true, global.sys["EncryptSysPlaintext"], { LoginID: LocalID, SysPlaintext: $("#miyao").val() }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    SysCiphertext = data.Data;
                    psw = SysCiphertext;
                    var cardinfo = "{\"card_snr\":\"" + cardsnr + "\",\"card_key\":\"" + psw
                    + "\",\"blockdatas\":[{\"Key\":29,\"Value\":\"00000000000000000000000000000000\"},{\"Key\":4,\"Value\":\"00000000000000000000000000000000\"}]}";
                    cardinfo = ActiveX.RFMifare_AllWriteCard(cardinfo);
                    var cardinfojson = JSON2.parse(cardinfo);
                    if (!cardinfojson.Success) {
                        $("#info").css("color", "Red");
                        $("#info").html("退卡失败，卡号：" + cardsnr + "，原因：错误信息：" + cardinfojson.Message);
                        rool = setTimeout(function () { readcard() }, rooltime);
                        return;
                    }
                    else {
                        Ajax(true, global.ms["RecycleCardUsing"], { LoginID: LocalID, card_id: cardid }, function (data) {
                            if (!data.Success) {
                                alert(data.Message);
                                rool = setTimeout(function () { readcard() }, rooltime);
                                return;
                            }
                            $("#info").css("color", "Green");
                            $("#info").html("退卡成功，卡号：" + cardsnr);
                            ActiveX.RFMifare_Alarm(4, 10, 0, 1);
                            rool = setTimeout(function () { readcard() }, rooltime);
                        });

                    }
                });
            }
        });
    });
    function loaddata(depart, kind, room, username, useridnum) {
        datagrid.datagrid('unselectAll');
        Ajax(true, global.sys["GetUserFilePageListOfTK"], { LoginID: LocalID, user_name: username, kind_name: kind, depart_name: depart, room_name: room, userid_num: useridnum,
            sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum
        }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            jsondata.total = data.Ex;
            jsondata.rows = data.Data;
            datagrid.datagrid('loadData', jsondata);
            if (jsondata.total == 0) {
                PageNum = 1;
            }
            var p = datagrid.datagrid('getPager');
            $(p).pagination({
                beforePageText: '第', //页数文本框前显示的汉字 
                afterPageText: '页    共 ' + Math.ceil(jsondata.total / PageSize) + ' 页',
                displayMsg: '当前显示 ' + (PageSize * (PageNum - 1) + (jsondata.total == 0 ? 0 : 1)) + ' - ' + (PageSize * (PageNum - 1) + data.Data.length) + ' 条记录   共 ' + jsondata.total + ' 条记录',
                onSelectPage: function (pageNumber, pageSize) {
                    PageSize = pageSize;
                    PageNum = pageNumber;
                    if (PageNum < 1) {
                        PageNum = 1;
                    }
                    loaddata($("#departname").val(), $("#kindname").val(), $("#roomname").val(), $("#username").val(), $("#useridnum").val());
                }
            });
        });
    }
    function make14() {
        var demo = "";
        var curr_time = new Date();
        var cdid;
        var psw;
        var dangqianmima;
        Ajax(true, global.sys["DecryptSysCiphertext"], { LoginID: LocalID, SysCiphertext: TKPlaintext }, function (data) {
            if (!data.Success) {
                alert(data.Message);
                return;
            }
            dangqianmima = data.Data;
            if ($("#mima").combobox("getValue") == "1") {
                psw = SysOriginalCiphertext;
                var bt = $('#bt').datebox('getValue') + "00:00:00";
                var et = $('#et').datebox('getValue') + "23:59:59";
                var bbt = bt.substr(2, 2) + bt.substr(5, 2) + bt.substr(8, 2) + "0000";
                var eet = et.substr(2, 2) + et.substr(5, 2) + et.substr(8, 2) + "2359";
                var card = $("#card").val();
                if (card == "") {
                    $.messager.alert("提示", "请放好卡", "error", function () { });
                    return true;
                }
                var rowData = datagrid.datagrid('getSelected');
                if (rowData == null) {
                    $.messager.alert("提示", "请选择用户", "error", function () { });
                    return true;
                }
                var userid = rowData.id;
                var username = rowData.user_name;
                Ajax(true, global.ms["GetCardID"], { LoginID: LocalID }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    cdid = data.Data;
                    demo = "卡类型：密码卡；" + "卡号：" + card + "；";
                    var TKMadeCard = { "lonSecNo": 7, "strCdsnr": card, "card_key": psw };
                    var XFMSCardInfo = { "user_kind": "00", "card_kind": "14", "card_id": cdid, "begin_time": bbt, "end_time": eet };
                    var xfcardinfo = ActiveX.RFMifare_XFWriteCard(JSON2.stringify(TKMadeCard), JSON2.stringify(XFMSCardInfo));
                    var xfcardinfojson = JSON2.parse(xfcardinfo);
                    if (!xfcardinfojson.Success) {
                        $("#info").css("color", "Red");
                        $("#info").html("制卡失败，卡号：" + card + "，原因：错误信息：" + xfcardinfojson.Message);
                        rool = setTimeout(function () { readcard() }, rooltime);
                        return;
                    }
                    else {
                        var cardinfo = ActiveX.RFMifare_XQWritePswCard(JSON2.stringify(TKMadeCard), dangqianmima);
                        var cardinfojson = JSON2.parse(cardinfo);
                        if (!cardinfojson.Success) {
                            $("#info").css("color", "Red");
                            $("#info").html("制卡失败，卡号：" + card + "，原因：错误信息：" + cardinfojson.Message);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        else {
                            Ajax(true, global.xq["NewXQMadeCardLog"], { LoginID: LocalID, card_id: cdid, card_snr: card, user_name: username, demo: demo }, function (data) {
                                if (!data.Success) {
                                    alert(data.Message);
                                    rool = setTimeout(function () { readcard() }, rooltime);
                                    return;
                                }
                                $("#info").css("color", "Green");
                                $("#info").html("制卡成功，卡号：" + cardsnr + "," + demo);
                                ActiveX.RFMifare_Alarm(4, 10, 0, 1);
                                rool = setTimeout(function () { readcard() }, rooltime);
                                return;
                            });
                        }
                    }
                });
            }
            if ($("#mima").combobox("getValue") == "2") {
                Ajax(true, global.sys["EncryptSysPlaintext"], { LoginID: LocalID, SysPlaintext: $("#miyao").val() }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    SysCiphertext = data.Data;
                    psw = SysCiphertext;
                    var bt = $('#bt').datebox('getValue') + "00:00:00";
                    var et = $('#et').datebox('getValue') + "23:59:59";
                    var bbt = bt.substr(2, 2) + bt.substr(5, 2) + bt.substr(8, 2) + "0000";
                    var eet = et.substr(2, 2) + et.substr(5, 2) + et.substr(8, 2) + "2359";
                    var card = $("#card").val();
                    if (card == "") {
                        $.messager.alert("提示", "请放好卡", "error", function () { });
                        return true;
                    }
                    var rowData = datagrid.datagrid('getSelected');
                    if (rowData == null) {
                        $.messager.alert("提示", "请选择用户", "error", function () { });
                        return true;
                    }
                    var userid = rowData.id;
                    var username = rowData.user_name;
                    Ajax(true, global.ms["GetCardID"], { LoginID: LocalID }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            return;
                        }
                        cdid = data.Data;
                        demo = "卡类型：密码卡；" + "卡号：" + card + "；";
                        var TKMadeCard = { "lonSecNo": 7, "strCdsnr": card, "card_key": psw };
                        var XFMSCardInfo = { "user_kind": "00", "card_kind": "14", "card_id": cdid, "begin_time": bbt, "end_time": eet };
                        var xfcardinfo = ActiveX.RFMifare_XFWriteCard(JSON2.stringify(TKMadeCard), JSON2.stringify(XFMSCardInfo));
                        var xfcardinfojson = JSON2.parse(xfcardinfo);
                        if (!xfcardinfojson.Success) {
                            $("#info").css("color", "Red");
                            $("#info").html("制卡失败，卡号：" + card + "，原因：错误信息：" + xfcardinfojson.Message);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        else {
                            var cardinfo = ActiveX.RFMifare_XQWritePswCard(JSON2.stringify(TKMadeCard), dangqianmima);
                            var cardinfojson = JSON2.parse(cardinfo);
                            if (!cardinfojson.Success) {
                                $("#info").css("color", "Red");
                                $("#info").html("制卡失败，卡号：" + card + "，原因：错误信息：" + cardinfojson.Message);
                                rool = setTimeout(function () { readcard() }, rooltime);
                                return;
                            }
                            else {
                                Ajax(true, global.xq["NewXQMadeCardLog"], { LoginID: LocalID, card_id: cdid, card_snr: card, user_name: username, demo: demo }, function (data) {
                                    if (!data.Success) {
                                        alert(data.Message);
                                        rool = setTimeout(function () { readcard() }, rooltime);
                                        return;
                                    }
                                    $("#info").css("color", "Green");
                                    $("#info").html("制卡成功，卡号：" + cardsnr + "," + demo);
                                    ActiveX.RFMifare_Alarm(4, 10, 0, 1);
                                    rool = setTimeout(function () { readcard() }, rooltime);
                                    return;
                                });
                            }
                        }
                    });
                });
            }
        });
    }
    var ext = false;
    function readcard() {
        var currentcardsnr = ActiveX.RFMifare_GetSnr();
        if (currentcardsnr == "") {
            if (cardsnr != "") {
                $("#card").val("");
                $("#depart").val("");
                $("#text").val("");
                $("#room").val("");
                $("#wei").html("");
            }
            $("#info").css("color", "Blue");
            $("#info").html("读卡中……");
            cot++;
            if (cot > maxcot) {
                $("#info").css("color", "Red");
                $("#info").html("长时间未读到卡，已停止工作，要继续请刷新页面");
                return;
            }
        }
        else {
            cot = 0;
        }
        if (currentcardsnr == "" || currentcardsnr == cardsnr) {
            cardsnr = currentcardsnr;
            rool = setTimeout(function () { readcard() }, rooltime);
            return;
        }
        cardsnr = currentcardsnr;
        $("#info").css("color", "Green");
        $("#info").html("读卡成功，卡号为：" + cardsnr);
        $("#card").val(cardsnr);
        var TKMadeCard = { "lonSecNo": 7, "strCdsnr": cardsnr, "card_key": TKPlaintext };
        var cardinfo = ActiveX.RFMifare_MSGetCardID(JSON2.stringify(TKMadeCard));
        cardid = JSON2.parse(cardinfo).Data;
        if (cardid == "000000") {
            $("#depart").val("");
            $("#text").val("");
            $("#info").css("color", "Green");
            $("#info").html("读卡成功，卡号：" + cardsnr + ",是否制卡");
            ext = false;
            rool = setTimeout(function () { readcard() }, rooltime);
            return;
        }
        else {
            Ajax(true, global.ms["GetCardUsing"], { LoginID: LocalID, card_id: cardid }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    rool = setTimeout(function () { readcard() }, rooltime);
                    return;
                }
                $("#depart").val(data.Data.depart_name);
                $("#text").val(data.Data.user_name);
                $("#cardno").val(data.Data.num_incard);
                if (data.Data.work_status == "us") {
                    var hs = "";
                    var ck = "";
                    var na = "，用户名：" + data.Data.user_name;
                    var bm = "，部门：" + data.Data.depart_name;
                    if (data.Data.issu_num != "" && data.Data.issu_num != null) {
                        hs = "，补卡次数：" + data.Data.issu_num;
                        if (data.Data.card_kind == "03") {
                            ck = "，卡类型：用户卡";
                            $("#info").css("color", "Green");
                            $("#info").html("读卡成功，卡号：" + cardsnr + ck + na + bm + hs);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        else if (data.Data.card_kind == "07") {
                            ck = "，卡类型：补用户卡";
                            $("#info").css("color", "Green");
                            $("#info").html("读卡成功，卡号：" + cardsnr + ck + na + bm + hs);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        else if (data.Data.card_kind == "08") {
                            ck = "，卡类型：应急卡";
                            $("#info").css("color", "Green");
                            $("#info").html("读卡成功，卡号：" + cardsnr + ck + na + bm + hs);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        else if (data.Data.card_kind == "02") {
                            ck = "，卡类型：补应急卡";
                            $("#info").css("color", "Green");
                            $("#info").html("读卡成功，卡号：" + cardsnr + ck + na + bm + hs);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                    }
                }
                else if (data.Data.work_status == "lt") {
                    $("#info").css("color", "Green");
                    $("#info").html("读卡成功，卡号：" + cardsnr + ",挂失卡");
                    ext = false;
                    rool = setTimeout(function () { readcard() }, rooltime);
                    return;
                }
                else if (data.Data.work_status == "kl") {
                    $("#info").css("color", "Green");
                    $("#info").html("读卡成功，卡号：" + cardsnr + ",报废卡");
                    ext = false;
                    rool = setTimeout(function () { readcard() }, rooltime);
                    return;
                }
                else if (data.Data.work_status == "re") {
                    $("#info").css("color", "Green");
                    $("#info").html("读卡成功，卡号：" + cardsnr + ",回收卡");
                    ext = false;
                    rool = setTimeout(function () { readcard() }, rooltime);
                    return;
                }
                else {
                    Ajax(true, global.xq["GetXQMadeCardLog"], { LoginID: LocalID, card_id: cardid }, function (data) {
                        if (!data.Success) {
                            alert(data.Message);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        ext = true;
                        var de = data.Data.demo;
                        var name = data.Data.user_name;
                        if (data.Data.card_id != null) {
                            $("#info").css("color", "Green");
                            $("#info").html("读卡成功，" + de);
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        else if (data.Data.card_id == null) {
                            $("#depart").val("");
                            $("#text").val("");
                            $("#info").css("color", "Green");
                            $("#info").html("读卡成功，卡号：" + cardsnr + ",是否制卡");
                            ext = false;
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                        else {
                            rool = setTimeout(function () { readcard() }, rooltime);
                            return;
                        }
                    });
                }
            });

        }
    }
</script>

</head>
<body>
<div class="easyui-layout" data-options="fit:true">
    <div data-options="region:'north',collapsible:false" title="提示" style="padding:5px 0 0; height:80px;">
        <div id="tou" style="width:600px;text-align:left; color:Blue; font-weight:bold; font-size:large;">手动操作中……</div>
        <div id="info" style="width:800px;text-align:left; color:Blue; font-weight:bold; font-size:large;">请把卡片放到读卡器上</div>
    </div>  
    <div data-options="region:'center',collapsible:false, border:false" style="padding:0px;width:300px; ">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'north',collapsible:false,border:false" style="height:240px;">
                <div class="easyui-panel"  data-options="collapsible:true" title="卡信息" style="width:100%;height:154px; padding:2px;">
                    <div style="width:100%;height:30px;">
                    类型：<select id="select" class="easyui-combobox" data-options="prompt:'类型'" style="width:110px"><option value="14" >密码卡</option></select>
                    用户：<input id="text" class="easyui-validatebox textbox" data-options="prompt:'用户'" style="width:80px;" readonly />
                    部门：<input id="depart" class="easyui-validatebox textbox" data-options="prompt:'部门'" style="width:80px;" readonly/>
                    改密码方式：<select id="mima" class="easyui-combobox" data-options="prompt:'改密码方式'" style="width:110px"><option value="1" >出厂密钥</option><option value="2" >手输密钥</option></select>
                    </div>
                    <div style="width:100%;height:30px;">
                    卡号：<input id="card" class="easyui-validatebox textbox" data-options="prompt:'卡号'" style="width:80px;" readonly />
                    卡面编号：<input id="cardno" class="easyui-validatebox textbox" data-options="prompt:'卡面编号'" style="width:50px;" readonly/>
                    生效日期：<input id="bt" class="easyui-datebox"  style="width:100px;" data-options="required:true" />
                    失效日期：<input id="et" class="easyui-datebox"  style="width:100px;" data-options="required:true" />
                    </div>
                    <div id="mi1"style="width:100%;height:30px;" >
                    密钥：<input id="miyao" class="easyui-validatebox textbox" type="password" data-options="prompt:'请输入密钥',required:true,validType:'length[6,6]'" />
                    </div>
                    <div style="width:100%;height:30px;" >
  	                <a href="javascript:void(0)" class="easyui-linkbutton" id="make" style="width:60px;" >制卡</a>
  	                <a href="javascript:void(0)" class="easyui-linkbutton" id="recy"style="width:60px;" >退卡</a>
                    </div>
                </div><div style="width:100%;height:2px;"></div>
                 
                 <div style="width:100%;height:2px;"></div>
                  <div class="easyui-panel" title="条件搜索" data-options="iconCls:'icon-search',collapsible:true" style="width:100%;height:70px; padding:3px;">
                部门：<input id="departname" class="easyui-validatebox textbox" data-options="prompt:'部门'" style="width:70px;"/>
                类型：<input id="kindname" class="easyui-validatebox textbox" data-options="prompt:'用户类型'" style="width:60px;"/>
                用户：<input id="username" class="easyui-validatebox textbox" data-options="prompt:'用户'" style="width:60px;"/>
                工号：<input id="useridnum" class="easyui-validatebox textbox" data-options="prompt:'工号'" style="width:60px;"/>
                房间：<input id="roomname" class="easyui-validatebox textbox" data-options="prompt:'房间'" style="width:70px;"/>
  	            <a href="javascript:void(0)" class="easyui-linkbutton" id="search" data-options="iconCls:'icon-search'">查询</a>
             </div>
                 <div style="width:100%;height:2px;"></div>
            </div>	
		<div data-options="region:'center',collapsible:false, border:false" style="padding:0px;width:250px; ">
            <div style="width:100%; height:100px;">
                    <table id="dg"> </table>
            </div>
		</div>
        </div>
    </div>
</div>
    <object id="ActiveX" type="application/x-itst-activex" classid="clsid:A01FC1A7-E754-478C-979E-4EC8B8E31A06" style="width:0px; height:0px;" codebase="ActiveX.ActiveX#version=1,0,0,0">
    </object>

</body>
</html>
