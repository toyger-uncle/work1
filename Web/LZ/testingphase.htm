<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/scene_lang_ch.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery/ajaxfileupload.js" type="text/javascript"></script>
    <style type="text/css">
        body
        {
            font-family: verdana,helvetica,arial,sans-serif,宋体;
            font-size: 12px;
            margin: 0;
            padding: 2px;
        }
    </style>
    <script type="text/javascript">
        var LocalID = $.cookie("LocalID");
        var datagrid;
        var datagrid2;
        var dd;
        var fileChange = false;
        var jsondata = { "total": 0, "rows": [] };
        var jsondata2 = { "total": 0, "rows": [] };
        var sortName = "id";
        var sortOrder = "asc";
        var PageSize = 10;
        var PageNum = 1;
        var demand_user_id = LocalID;
        var test_header_id;
        var test_header;
        var project_manager_id;
        var project_manager;
        var role_id;
        var flag;
        $(function () {
            Ajax(true, global.sys["GetUserFile"], { LoginID: LocalID, id: demand_user_id }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                test_grouper = data.Data.user_name;
            });
            Ajax(true, global.lz["GetLZUserRole"], { LoginID: LocalID, user_id: demand_user_id,role_id:"08" }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                role_id = data.Data.role_id;
            });
            Ajax(true, global.lz["GetLZUserRoleList"], { LoginID: LocalID, role_id: "11" }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#select').combobox({
                    data: data.Data,
                    valueField: 'user_id',
                    textField: 'user_name',
                    onLoadSuccess: function () {
                        var data = $('#select').combobox('getData');
                        $("#select ").combobox('select', data[0].user_id);
                    }
                });
            });
            Ajax(true, global.lz["GetLZUserRoleList"], { LoginID: LocalID, role_id: "07" }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#test_header').combobox({
                    data: data.Data,
                    valueField: 'user_id',
                    textField: 'user_name'
                });
            });

            Ajax(true, global.lz["GetLZUserRoleList"], { LoginID: LocalID, role_id: "09" }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                $('#test_group_users').combobox({
                    data: data.Data,
                    valueField: 'user_id',
                    textField: 'user_name',
                    multiple: true,
                    editable: false,
                    selectOnCheck: true,
                    checkOnSelect: true,
                    formatter: function (row) {
                        var opts;
                            opts = "<input type='checkbox' id='" + row.id + "' value='" + row.user_id + "'>" + row.user_name + "</input>";
                        return opts;
                    },
                    onSelect: function (row) {
                        oCheckbox = document.getElementById(row.id);
                        oCheckbox.checked = true;
                    },
                    onUnselect: function (row) {
                        oCheckbox = document.getElementById(row.id);
                        oCheckbox.checked = false;
                    }
                });
            });
            datagrid2 = $("#tb").datagrid({
                idField: "user_id",
                singleSelect: false,
                fitColumns: true,
                striped: true,
                title: "",
                collapsible: true,
                remotesort: false,
                checkOnSelect: true,
                showHeader: false,
                selectOnCheck: true,
                columns: [[{
                    field: 'user_name',
                    title: '',
                    //                sortable: true,
                    width: "100%"
                }]]
            });
            datagrid = $("#dg").datagrid({
                idField: "id",
                fitColumns: true,
                striped: true,
                title: "",
                collapsible: true,
                remotesort: false,
                sortName: sortName,
                sortOrder: sortOrder,
                rownumbers: true,
                singleSelect: true,
                columns: [[{
                    field: 'project_no',
                    title: '项目编号',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'project_name',
                    title: '项目名',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'customer',
                    title: '客户',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'end_date',
                    title: '要求完成时间',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'contact',
                    title: '技术联系人',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'tel',
                    title: '联系方式',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'demand_depart_name',
                    title: '需求部门',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'demand_user_name',
                    title: '需求者',
                    //                sortable: true,
                    width: 20
                }, {
                    field: 'status_flag',
                    title: '流转进度',
                    //                sortable: true,
                    width: 20,
                    formatter: function (value, row) {
                        if (value == "1") {
                            return '需求发起';
                        }
                        if (value == "-1") {
                            return '研发驳回';
                        }
                        if (value == "2") {
                            return '审批中';
                        }
                        if (value == "-2") {
                            return '审批驳回';
                        }
                        if (value == "3") {
                            return '开发中';
                        }
                        if (value == "4") {
                            return '测试中';
                        }
                        if (value == "5") {
                            return '验证中';
                        }
                        if (value == "6") {
                            return '结案中';
                        }
                        if (value == "7") {
                            return '结案';
                        }
                        if (value == "0") {
                            return '草案';
                        }
                    }
                }, {
                    field: 'flag',
                    title: '流转状态',
                    //                sortable: true,
                    width: 20,
                    formatter: function (value, row) {
                        if (value == "0") {
                            return '结案';
                        }
                        if (value == "1") {
                            return '流转中';
                        }
                        if (value == "2") {
                            return '作废';
                        }
                        if (value == "3") {
                            return '暂停';
                        }
                    }
                }]],
                onDblClickRow: function (rowIndex, rowData) {
                    if (role_id == 08) {
                        $('#win').window('open');
                        var id = rowData.id;
                        Ajax(true, global.lz["GetLZProjectFlow"], { LoginID: LocalID, id: id }, function (data) {
                            if (!data.Success) {
                                alert(data.Message);
                                return;
                            }
                            $("#demand_content").textbox("setValue", data.Data.demand_content);
                        });
                        var project_name = $("#project_name").val(rowData.project_name);
                        $("#project_name").val(rowData.project_name);
                        $("#end_date").val(rowData.end_date.substring(0, 10));
                        $("#customer").val(rowData.customer);
                        $("#contact").val(rowData.contact);
                        $("#tel").val(rowData.tel);
                        $("#project_name").attr("disabled", true);
                        $("#end_date").attr("disabled", true);
                        $("#customer").attr("disabled", true);
                        $("#contact").attr("disabled", true);
                        $("#tel").attr("disabled", true);
                        $("#demand_content").textbox({ disabled: true });
                        $("#test_grouper_content").textbox("setValue");
                        $("#test_begin_date").datetimebox('setValue');
                        $("#test_end_date").datetimebox('setValue');
                        $("#test_score").val("");
                        $("#test_header").combobox("setValue", "");
                        $("#test_group_users").combobox("setValue", "");
                        dd = 1;
                        loadfile(id, project_name);
                    }
                    else {
                        $.messager.alert("提示", "您无权限，请找相关人员获取权限", "info");
                    }
                }
            });
            loaddata();
            $("#file_upload").change(function () {
                loadfj();
            });
            $('#win').window('close');
            $("#save").click(function () {
                if (role_id == 08) {
                    var rows = datagrid.datagrid('getSelected');
                    var id = rows.id;
                    project_manager_id = $("#select").combobox("getValue");
                    test_header_id = $("#test_header").combobox("getValue");

                    if (dd == 1) {
                        var project_name = $("#project_name").val();
                        var end_date = $("#end_date").val();
                        var customer = $("#customer").val();
                        var contact = $("#contact").val();
                        var tel = $("#tel").val();
                        var demand_content = $("#demand_content").textbox("getValue");
                        $("#project_name").attr("disabled", true);
                        $("#end_date").attr("disabled", true);
                        $("#customer").attr("disabled", true);
                        $("#contact").attr("disabled", true);
                        $("#tel").attr("disabled", true);
                        $("#demand_content").attr("disabled", true);
                        test_header = $("#test_header").combobox("getText");
                        project_manager = $("#select").combobox("getText");
                        var test_grouper_content = $("#test_grouper_content").textbox("getValue");
                        var test_begin_date = $("#test_begin_date").datetimebox('getValue');
                        var test_end_date = $("#test_end_date").datetimebox('getValue');
                        var test_score = $("#test_score").val();
                        var test_group_users = $("#test_group_users").combobox("getText");
                        if (test_begin_date == "") {
                            $.messager.alert("提示", "测试开始日期不能为空！", "error");
                            $("#select").combobox();
                            return;
                        }
                        if (test_end_date == "") {
                            $.messager.alert("提示", "测试结束日期不能为空！", "error");
                            $("#select").combobox();
                            return;
                        }
                        if (test_score == "") {
                            $.messager.alert("提示", "评分不能为空！", "error");
                            $("#select").combobox();
                            return;
                        }
                        if (project_manager_id == "") {
                            $.messager.alert("提示", "验证人不能为空！", "error");
                            $("#select").combobox();
                            return;
                        }
                        if (test_grouper_content.length > 500) {
                            $.messager.alert("提示", "输入字数不能超过500字！", "error");
                            $("#select").combobox();
                            return;
                        }
                        Ajax(true, global.lz["UpdateLZProjectFlowCSZZ"], { LoginID: LocalID, id: id, test_header_id: test_header_id, test_header: test_header, project_manager_id: project_manager_id, project_manager: project_manager, test_grouper_content: test_grouper_content, test_begin_date: test_begin_date, test_end_date: test_end_date, test_score: test_score, test_group_users: test_group_users }, function (data) {
                            if (!data.Success) {
                                alert(data.Message);
                                return;
                            }
                            $.messager.alert("提示", "修改成功", "info");
                            $('#win').window('close');
                            loaddata();
                        });
                    }
                }
                else {
                    $.messager.alert("提示", "您无权限，请找相关人员获取权限", "info");
                    $("#select").combobox();
                }
            });
            $("#close").click(function () {
                $('#win').window('close');
            });
        });
        function delcs() {
            var rows = datagrid.datagrid('getSelected');
            var id = rows.id;
            var project_name = rows.project_name;
            Ajax(true, global.lz["ClearLZTestFile"], { LoginID: LocalID, id: id, ids: 1 }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                loadfile(id, project_name);
            });
        }
        function delcs2() {
            var rows = datagrid.datagrid('getSelected');
            var id = rows.id;
            var project_name = rows.project_name;
            Ajax(true, global.lz["ClearLZTestFile"], { LoginID: LocalID, id: id, ids: 2 }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                loadfile(id, project_name);
            });
        }
        function delcs3() {
            var rows = datagrid.datagrid('getSelected');
            var id = rows.id;
            var project_name = rows.project_name;
            Ajax(true, global.lz["ClearLZTestFile"], { LoginID: LocalID, id: id, ids: 3 }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                loadfile(id, project_name);
            });
        }
        function loadfj() {
            var rows = datagrid.datagrid('getSelected');
            var id = rows.id;
            var project_name = rows.project_name;
            ajaxFileUpload(global.lz["UpLZTestFile"], { LoginID: LocalID, id: id, project_name: rows.project_name }, "file_upload", function (data, status) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                loadfile(id, project_name);
                $("#file_upload").bind("change", function () {
                    loadfj();
                });
            });
        }

        function formatDateTime(date) {
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            m = m < 10 ? ('0' + m) : m;
            var d = date.getDate();
            d = d < 10 ? ('0' + d) : d;
            var h = date.getHours();
            var minute = date.getMinutes();
            var second = date.getSeconds();
            minute = minute < 10 ? ('0' + minute) : minute;
            second = second < 10 ? ('0' + second) : second;
            return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;
        }
       
        function loadfile(id, project_name) {
            Ajax(true, global.lz["GetLZProjectFlowEx"], { LoginID: LocalID, id: id }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                var fj = "";
                var fj2 = "";
                if (data.Data.demand_file != "") {
                    fj += '<a href="' + '../../LZ/' + project_name + '/' + data.Data.demand_file + '">' + data.Data.demand_file + '</a><br />';
                }

                if (data.Data.demand_file2 != "") {
                    fj += '<a href="' + '../../LZ/'  + project_name + '/'+ data.Data.demand_file2 + '">' + data.Data.demand_file2 + '</a><br />';
                }
                if (data.Data.demand_file3 != "") {
                    fj += '<a href="' + '../../LZ/' + project_name + '/' + data.Data.demand_file3 + '">' + data.Data.demand_file3 + '</a><br />';
                }
                if (data.Data.develop_file != "") {
                    fj += '<a href="' + '../../LZ/' + project_name + '/' + data.Data.develop_file + '">' + data.Data.develop_file + '</a><br />';
                }

                if (data.Data.develop_file2 != "") {
                    fj += '<a href="' + '../../LZ/'  + project_name + '/'+ data.Data.develop_file2 + '">' + data.Data.develop_file2 + '</a><br />';
                }
                if (data.Data.develop_file3 != "") {
                    fj += '<a href="' + '../../LZ/'  + project_name + '/'+ data.Data.develop_file3 + '">' + data.Data.develop_file3 + '</a><br />';
                }
                if (data.Data.test_file != "") {
                    fj2 += '<a href="' + '../../LZ/'  + project_name + '/'+ data.Data.test_file + '">' + data.Data.test_file + '</a>' + '<button onclick="delcs()">删除</button><br />';
                }
                if (data.Data.test_file2 != "") {
                    fj2 += '<a href="' + '../../LZ/' + project_name + '/' + data.Data.test_file2 + '">' + data.Data.test_file2 + '</a>' + '<button onclick="delcs2()">删除</button><br />';
                }
                if (data.Data.test_file3 != "") {
                    fj2 += '<a href="' + '../../LZ/' + project_name + '/' + data.Data.test_file3 + '">' + data.Data.test_file3 + '</a>' + '<button onclick="delcs3()">删除</button><br />';
                }
                document.getElementById('download').innerHTML = fj;
                document.getElementById('download2').innerHTML = fj2;

            });
        }
        function loaddata() {
            datagrid.datagrid('unselectAll');
            var row = datagrid.datagrid('getSelected');
            Ajax(true, global.lz["GetLZProjectPageList"], { LoginID: LocalID, status_flag: "4", flag: "1", demand_user_id: demand_user_id }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jsondata.rows = data.Data;
                datagrid.datagrid('loadData', jsondata);
                jsondata.total = data.Ex;
                if (jsondata.total == 0) {
                    PageNum = 1;
                }
                var p = datagrid.datagrid('getPager');
                $(p).pagination({
                    beforePageText: '第', //页数文本框前显示的汉字 
                    afterPageText: '页    共 ' + Math.ceil(jsondata.total / PageSize) + ' 页',
                    displayMsg: '当前显示 ' + (PageSize * (PageNum - 1) + (jsondata.total == 0 ? 0 : 1)) + ' - ' + (PageSize * (PageNum - 1) + data.Data.length) + ' 条记录   共 ' + jsondata.total + ' 条记录',
                    onSelectPage: function (pageNumber, pageSize) {
                        PageSize = pageSize;
                        PageNum = pageNumber;
                        if (PageNum < 1) {
                            PageNum = 1;
                        }
                        loaddata();
                    }
                });
            });

        }
    </script>
</head>
<body>
    <div class="easyui-panel" title="测试" data-options="iconCls:'icon-search',collapsible:false,maximized:true"
        style="width: 100%;">
        <div style="width: 100%; height: 400px;">
            <table id="dg" style="padding: 5px;" data-options="pagination:true">
            </table>
        </div>
    </div>
    <div id="win" class="easyui-window" title="测试" data-options="iconCls:'icon-save',minimizable:false,maximizable:false"
        style="width: 500px; height: 471px; padding: 5px;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'north'" style="padding: 5px;">
                <table cellpadding="5">
                    <tr>
                        <td>
                            项目名称：
                        </td>
                        <td>
                            <input id="project_name" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                height: 20px" />
                        </td>
                        <td>
                            要求完成时间：
                        </td>
                        <td>
                            <input id="end_date" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                height: 20px" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            客户名称：
                        </td>
                        <td>
                            <input id="customer" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                height: 20px" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            技术联系人：
                        </td>
                        <td>
                            <input id="contact" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                height: 20px" />
                        </td>
                        <td>
                            联系方式：
                        </td>
                        <td>
                            <input id="tel" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                height: 20px" />
                        </td>
                    </tr>
                </table>
                <table cellpadding="1px" cellspacing="5px">
                    <tr>
                        <td>
                            描述：
                        </td>
                        <td>
                            <input id="demand_content" class="easyui-textbox" data-options="multiline:true" style="width: 400px;
                                height: 50px;" readonly="readonly" />
                        </td>
                    </tr>
                </table>
                <table>
                    <tr>
                        <td id="download">
                        </td>
                    </tr>
                </table>
            </div>
            <div data-options="region:'center'," style="padding: 5px;">
                <div class="easyui-layout" data-options="fit:true">
                    <div data-options="region:'north'" style="padding: 5px;">
                        <table cellpadding="5">
                            <tr>
                                <td>
                                    测试负责人：
                                </td>
                                <td>
                                    <select id="test_header" class="easyui-combobox" style="width: 120px;">
                                    </select>
                                </td>
                                <td>
                                    测试组成员：
                                </td>
                                <td>
                                    <input id="test_group_users" name="test_group_users" style="width: 120px;" />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    测试开始：
                                </td>
                                <td>
                                    <input id="test_begin_date" class="easyui-datetimebox" data-options="" style="width: 120px;
                                        height: 20px" />
                                </td>
                                <td>
                                    测试结束：
                                </td>
                                <td>
                                    <input id="test_end_date" class="easyui-datetimebox" data-options="" style="width: 120px;
                                        height: 20px" />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    项目评分：
                                </td>
                                <td>
                                    <input id="test_score" class="easyui-validatebox textbox" data-options="" style="width: 120px;
                                        height: 20px" />
                                </td>
                            </tr>
                        </table>
                        <table>
                            <tr>
                                <td>
                                    描述：
                                </td>
                                <td>
                                    <input id="test_grouper_content" class="easyui-textbox" data-options="multiline:true"
                                        style="width: 400px; height: 50px;" maxlength="500" />
                                </td>
                            </tr>
                        </table>
                        <table>
                            <tr>
                                <td>
                                    附件:
                                </td>
                                <td>
                                    <input id="file_upload" type="file" style="width: 200px;" name="file_upload" />
                                </td>
                            </tr>
                        </table>
                        <table>
                            <tr>
                                <td id="download2">
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)"
                    id="close" style="width: 80px">关闭</a> <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'"
                        href="javascript:void(0)" id="save" style="width: 80px">确定</a>转到<select id="select"
                            class="easyui-combobox" style="width: 100px;">
                        </select>
            </div>
        </div>
    </div>
</body>
</html>
