<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title></title>	
    <link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/default/easyui.css"/>
	<link rel="stylesheet" type="text/css" href="../../Scripts/jquery-easyui/themes/icon.css" />
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.min.js"></script>
	<script type="text/javascript" src="../../Scripts/jquery-easyui/jquery.easyui.min.js"></script>
    <script src="../../Scripts/jquery-easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/json2.js" type="text/javascript"></script>
    <script src="../../Scripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="../../Scripts/common.js" type="text/javascript"></script>	
    <script src="../../Scripts/scene_lang_ch.js" type="text/javascript"></script>
    <script src="../../Scripts/global.js" type="text/javascript"></script>
    <script type="text/javascript">
        var LocalID = $.cookie("LocalID");
        var datagrid;
        var jsondata = { "total": 0, "rows": [] };
        var rool;
        var cc = 10000;
        var datagrid1;
        var jsondata1 = { "total": 0, "rows": [] };
        var sortName = "id";
        var sortOrder = "asc";
        var PageSize = 10;
        var PageNum = 1;
        var sortName1 = "card_id";
        var sortOrder1 = "asc";
        var PageSize1 = 10;
        var PageNum1 = 1;
        var rool;
        $(function () {
            datagrid = $("#dg").datagrid({
                idField: "id",
                pagination: true, //显示分页  
                pageSize: PageSize, //分页大小  
                pageList: [10, 20, 50, 100], //每页的个数  
                //fit: true, //自动补全  
                fitColumns: true,
                striped: true,
                iconCls: "icon-search", //图标  
                title: "选择用户",
                collapsible: true,
                remotesort: false,
                singleSelect: true,
                //rownumbers:true,
                sortName: sortName,
                sortOrder: sortOrder,
                columns: [[{
                    field: 'id',
                    title: '编号',
                    sortable: true,
                    width: 50
                }, {
                    field: 'user_name',
                    title: '用户',
                    sortable: true,
                    width: 50
                }, {
                    field: 'depart_name',
                    title: '部门',
                    sortable: true,
                    width: 80
                }, {
                    field: 'kind_name',
                    title: '类型',
                    sortable: true,
                    width: 50
                }, {
                    field: 'sex',
                    title: '性别',
                    sortable: true,
                    width: 50
                }, {
                    field: 'userid_num',
                    title: '工号',
                    sortable: true,
                    width: 50
                }, {
                    field: 'role_name',
                    title: '角色',
                    sortable: true,
                    width: 80
                }, {
                    field: 'room_name',
                    title: '房间',
                    sortable: true,
                    width: 80
                }]],
                onSelect: function (rowIndex, rowData) {
                    if (rowData == null) {
                        $.messager.alert("提示", "未选择项", "error");
                        return;
                    }
                    loaddata1(rowData.id);
                },
                onSortColumn: function (sort, order) {
                    sortName = sort;
                    sortOrder = order;
                    loaddata($("#departname").val(), $("#kindname").val(), $("#username").val(), $("#useridnum").val());
                }
            });
            datagrid1 = $("#dg1").datagrid({
                idField: "id",
                pagination: true, //显示分页  
                pageSize: PageSize, //分页大小  
                pageList: [10, 20, 50, 100], //每页的个数  
                //fit: true, //自动补全  
                fitColumns: true,
                striped: true,
                iconCls: "icon-search", //图标  
                title: "用户卡",
                collapsible: true,
                remotesort: false,
                singleSelect: true,
                //rownumbers:true,
                sortName: sortName1,
                sortOrder: sortOrder1,
                columns: [[{
                    field: 'user_file_id',
                    title: '编号',
                    sortable: true,
                    width: 50
                }, {
                    field: 'user_name',
                    title: '用户',
                    sortable: true,
                    width: 50
                }, {
                    field: 'depart_name',
                    title: '部门',
                    sortable: true,
                    width: 80
                }, {
                    field: 'card_id',
                    title: '卡号',
                    sortable: true,
                    width: 50
                }, {
                    field: 'begin_date',
                    title: '开始时间',
                    sortable: true,
                    width: 80
                }, {
                    field: 'end_date',
                    title: '结束时间',
                    sortable: true,
                    width: 80
                }]],
                onSelect: function (rowIndex, rowData) {
                    if (rowData == null) {
                        $.messager.alert("提示", "未选择项", "error");
                        return;
                    }
                    $("#card").val(rowData.card_id);
                },
                onSortColumn: function (sort, order) {
                    sortName1 = sort;
                    sortOrder1 = order;
                    loaddata($("#departname").val(), $("#kindname").val(), $("#username").val(), $("#useridnum").val());
                }
            });
            loaddata($("#departname").val(), $("#kindname").val(), $("#username").val(), $("#useridnum").val());
            inipageSet();
            $("#search").click(function () {
                PageNum = 1;
                var p = datagrid.datagrid('getPager');
                p.pagination('select', 1);
            });
            $("#gs").click(function () {
                var card = $("#card").val();
                if (card == "") {
                    $.messager.alert("提示", "未选择人员", "error");
                    return;
                }
                if (card.length != 8) {
                    $.messager.alert("提示", "卡号长度不对", "error");
                    return;
                }
                Ajax(true, global.mj["LossCardMjCardUsing"], { LoginID: LocalID, card_id: card }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    $.messager.alert("提示", "挂失成功", "info");
                    loaddata();
                });
            });
            $("#bf").click(function () {
                var card = $("#card").val();
                if (card == "") {
                    $.messager.alert("提示", "未选择人员", "error");
                    return;
                }
                if (card.length != 8) {
                    $.messager.alert("提示", "卡号长度不对", "error");
                    return;
                }
                Ajax(true, global.mj["ScrappedCardMjCardUsing"], { LoginID: LocalID, card_id: card }, function (data) {
                    if (!data.Success) {
                        alert(data.Message);
                        return;
                    }
                    $.messager.alert("提示", "报废成功", "info");
                    loaddata();
                });
            });
        });
        function loaddata(depart, kind, username, useridnum) {
            datagrid.datagrid('unselectAll');
            Ajax(true, global.sys["GetUserFilePageListOfTK"], { LoginID: LocalID, user_name: username, kind_name: kind, depart_name: depart, userid_num: useridnum,
                sortName: sortName, sortOrder: (sortOrder == "asc" ? false : true), pageSize: PageSize, pageNum: PageNum
            }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jsondata.total = data.Ex;
                jsondata.rows = data.Data;
                datagrid.datagrid('loadData', jsondata);
                if (jsondata.total == 0) {
                    PageNum = 1;
                }
                var p = datagrid.datagrid('getPager');
                $(p).pagination({
                    beforePageText: '第', //页数文本框前显示的汉字 
                    afterPageText: '页    共 ' + Math.ceil(jsondata.total / PageSize) + ' 页',
                    displayMsg: '当前显示 ' + (PageSize * (PageNum - 1) + (jsondata.total == 0 ? 0 : 1)) + ' - ' + (PageSize * (PageNum - 1) + data.Data.length) + ' 条记录   共 ' + jsondata.total + ' 条记录',
                    onSelectPage: function (pageNumber, pageSize) {
                        PageSize = pageSize;
                        PageNum = pageNumber;
                        if (PageNum < 1) {
                            PageNum = 1;
                        }
                        loaddata($("#departname").val(), $("#kindname").val(), $("#username").val(), $("#useridnum").val());
                    }
                });
            });
        }
        function loaddata1(id) {
            datagrid1.datagrid('unselectAll');
            Ajax(true, global.mj["GetMjCardUsingPageList"], { LoginID: LocalID, user_file_id: id, sortName: sortName1, sortOrder: (sortOrder1 == "asc" ? false : true), pageSize: PageSize1, pageNum: PageNum1
            }, function (data) {
                if (!data.Success) {
                    alert(data.Message);
                    return;
                }
                jsondata1.total = data.Ex;
                jsondata1.rows = data.Data;
                datagrid1.datagrid('loadData', jsondata1);
                if (jsondata1.total == 0) {
                    PageNum1 = 1;
                }
                var p = datagrid1.datagrid('getPager');
                $(p).pagination({
                    beforePageText: '第', //页数文本框前显示的汉字 
                    afterPageText: '页    共 ' + Math.ceil(jsondata1.total / PageSize1) + ' 页',
                    displayMsg: '当前显示 ' + (PageSize1 * (PageNum1 - 1) + (jsondata1.total == 0 ? 0 : 1)) + ' - ' + (PageSize1 * (PageNum1 - 1) + data.Data.length) + ' 条记录   共 ' + jsondata1.total + ' 条记录',
                    onSelectPage: function (pageNumber, pageSize) {
                        PageSize1 = pageSize;
                        PageNum1 = pageNumber;
                        if (PageNum1 < 1) {
                            PageNum1 = 1;
                        }
                        loaddata1(datagrid.datagrid('getSelected').id);
                    }
                });
            });
        }
        function inipageSet() {
            var pager = $("#dg1").datagrid("getPager");
            pager.pagination({
                total: jsondata1.total,
                onSelectPage: function (pageNo, pageSize) {
                    var start = (pageNo - 1) * pageSize;
                    var end = start + pageSize;
                    //本地分页
                    $("#dg1").datagrid("loadData", jsondata1.rows.slice(start, end));
                    pager.pagination('refresh', {
                        total: jsondata.total,
                        pageNumber: pageNo
                    });
                }
            });
        };                         
</script>
</head>
<body>
    <div class="easyui-panel" title="挂失报废" data-options="collapsible:true,maximized:true" style="width:100%; padding:2px; ">
<div style="width:100%; height:400px;">
<div style="padding:5px;">
        部门：<input id="departname" class="easyui-validatebox textbox" data-options="prompt:'部门'" style="width:80px;"/>
                类型：<input id="kindname" class="easyui-validatebox textbox" data-options="prompt:'用户类型'" style="width:80px;"/>
                用户：<input id="username" class="easyui-validatebox textbox" data-options="prompt:'用户'" style="width:80px;"/>
                工号：<input id="useridnum" class="easyui-validatebox textbox" data-options="prompt:'工号'" style="width:80px;"/>
<a href="javascript:void(0)" class="easyui-linkbutton" style="width:60px;" id="search" >查询</a></br>
                卡号：<input id="card" class="easyui-validatebox textbox" data-options="prompt:'卡号'" style="width:120px;"/>
<a href="javascript:void(0)" class="easyui-linkbutton" style="width:60px;" id="gs" >挂失</a>
<a href="javascript:void(0)" class="easyui-linkbutton" style="width:60px;" id="bf" >报废</a>
</div>
		<table id="dg"style="padding: 5px;"data-options=""> </table>  
		<table id="dg1"style="padding: 5px;"data-options=""> </table> 
</div style="overflow:auto; ">
     </div>
</body>

</html>
